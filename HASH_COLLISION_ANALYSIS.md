# QueryRunner å“ˆå¸Œæ–¹æ³•åˆ†ææŠ¥å‘Š

## 1. å˜æ›´å†…å®¹

### ä»£ç ä½ç½®
`src/database/nebula/query/QueryRunner.ts` - `generateQueryHash()` æ–¹æ³•ï¼ˆç¬¬516-527è¡Œï¼‰

### å˜æ›´å†…å®¹
ä»è‡ªå®šä¹‰ç®€å•å“ˆå¸Œç®—æ³•æ›¿æ¢ä¸º HashUtils å·¥å…·ç±»ä¸­çš„ **FNV-1a ç®—æ³•**ï¼š

```typescript
// å˜æ›´å‰ï¼ˆç®€å•å“ˆå¸Œï¼‰
private generateQueryHash(query: string): string {
  const normalizedQuery = query.trim().replace(/\s+/g, ' ').toLowerCase();
  let hash = 0;
  for (let i = 0; i < normalizedQuery.length; i++) {
    const char = normalizedQuery.charCodeAt(i);
    hash = ((hash << 5) - hash + char) & 0xffffffff;
  }
  return hash.toString(36);
}

// å˜æ›´åï¼ˆFNV-1aï¼‰
private generateQueryHash(query: string): string {
  const normalizedQuery = query.trim().replace(/\s+/g, ' ').toLowerCase();
  return HashUtils.fnv1aHash(normalizedQuery);
}
```

---

## 2. QueryRunner æ¨¡å—å¯¹å“ˆå¸Œç¢°æ’çš„å®¹å¿åº¦åˆ†æ

### 2.1 ä½¿ç”¨åœºæ™¯

**QueryRunner ä¸­å“ˆå¸Œçš„ç”¨é€”ï¼š** `generateQueryHash()` æ–¹æ³•è™½ç„¶å·²å®šä¹‰ä½†å½“å‰æœªè¢«ä½¿ç”¨
- è¯¥æ–¹æ³•æ˜¯ä¸ºæœªæ¥çš„ä¼˜åŒ–é¢„ç•™ï¼ˆå¦‚ç›´æ¥å“ˆå¸Œç¼“å­˜é”®è€Œéå®Œæ•´æŸ¥è¯¢å­—ç¬¦ä¸²ï¼‰
- å®é™…ç¼“å­˜é”®ç”Ÿæˆç”± `QueryCache.generateKey()` æ–¹æ³•è´Ÿè´£ï¼Œä½¿ç”¨ MD5

### 2.2 æ¨¡å—å®¹å¿åº¦è¯„ä¼°

| ç»´åº¦ | å®¹å¿åº¦ | è¯´æ˜ |
|------|--------|------|
| **ç¼“å­˜å®¹é‡** | ä¸­ | æœ€å¤§1000é¡¹ï¼Œç©ºé—´æœ‰é™ |
| **æŸ¥è¯¢å¤šæ ·æ€§** | é«˜ | NebulaæŸ¥è¯¢è¯­å¥ç»„åˆå¤šï¼Œä¸æ˜“ç¢°æ’ |
| **ç¢°æ’åæœ** | ä½ | ç¼“å­˜ä¸­å­˜å‚¨å®Œæ•´æŸ¥è¯¢å’Œå‚æ•°ï¼Œç¢°æ’ä¼šå¯¼è‡´ç¼“å­˜å‘½ä¸­é”™è¯¯ |
| **å®¹å¿åº¦ç­‰çº§** | **ä¸­ç­‰** | éœ€è¦ä¸­ç­‰æŠ—ç¢°æ’èƒ½åŠ›ï¼Œä¸èƒ½å¤ªé«˜ä¹Ÿæ— éœ€åŠ å¯†çº§åˆ« |

### 2.3 å…³é”®åˆ†æç‚¹

**ä¸ºä»€ä¹ˆä¸èƒ½é«˜å®¹å¿ç¢°æ’ï¼š**
1. ç¼“å­˜ç›®çš„æ˜¯åŠ é€ŸæŸ¥è¯¢ï¼Œç¢°æ’ä¼šå¯¼è‡´ç¼“å­˜å‘½ä¸­é”™è¯¯ï¼ˆè¿”å›é”™è¯¯ç»“æœï¼‰
2. æ•°æ®åº“æ“ä½œå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜
3. å³ä½¿ä»…æ˜¯ç¼“å­˜ï¼Œé”™è¯¯ç»“æœä¼šå¯¼è‡´ä¸šåŠ¡é€»è¾‘é”™è¯¯

**ä¸ºä»€ä¹ˆä¸éœ€è¦åŠ å¯†çº§åˆ«å“ˆå¸Œï¼š**
1. è¿™ä¸æ˜¯å®‰å…¨ç›¸å…³åº”ç”¨ï¼ˆéç­¾åã€éè®¤è¯ï¼‰
2. ä¸éœ€è¦é•¿å­—ç¬¦ä¸²ï¼Œä»…éœ€è¦å¿«é€Ÿã€å‡åŒ€åˆ†å¸ƒçš„é”®
3. æ€§èƒ½å…³é”®ï¼Œé¢‘ç¹è°ƒç”¨å“ˆå¸Œå‡½æ•°ä¼šæˆä¸ºç“¶é¢ˆ

---

## 3. ä¸‰ç§å“ˆå¸Œç®—æ³•å¯¹æ¯”

### 3.1 ç®—æ³•ç‰¹æ€§å¯¹æ¯”

| ç‰¹æ€§ | ç®€å•å“ˆå¸Œ | FNV-1a | SHA256 |
|------|---------|--------|--------|
| **ç¢°æ’ç‡** | é«˜ï¼ˆâ‰ˆ1/2^16ï¼‰ | ä¸­ï¼ˆâ‰ˆ1/2^32ï¼‰ | æä½ï¼ˆâ‰ˆ1/2^128ï¼‰ |
| **åˆ†å¸ƒç‰¹æ€§** | å·®ï¼Œå±€éƒ¨åˆ†å¸ƒä¸å‡ | ä¼˜ï¼Œåˆ†å¸ƒå‡åŒ€ | å®Œç¾ï¼ŒåŠ å¯†çº§ |
| **æ€§èƒ½** | æœ€å¿« | å¿« | è¾ƒæ…¢ |
| **è¾“å‡ºé•¿åº¦(36è¿›åˆ¶)** | 6-8ä½ | 8-10ä½ | 50-52ä½ |
| **å­˜å‚¨ç©ºé—´** | æœ€å° | å° | å¤§ |
| **ç¢°æ’é£é™©** | âš ï¸ ä¸å¯æ¥å— | âœ“ å¯æ¥å— | âœ“âœ“ è¿‡åº¦å®‰å…¨ |

### 3.2 ç¢°æ’æ¦‚ç‡è®¡ç®—

**ç”Ÿæ—¥æ‚–è®ºï¼ˆBirthday Paradoxï¼‰**ï¼š
- å‡è®¾1000ä¸ªç¼“å­˜é¡¹ç›®

| ç®—æ³• | ç¢°æ’æ¦‚ç‡ | é£é™©è¯„ä¼° |
|------|--------|---------|
| ç®€å•å“ˆå¸Œï¼ˆ16ä½ï¼‰| ~36% | ğŸ”´ é«˜é£é™© |
| FNV-1aï¼ˆ32ä½ï¼‰| <0.01% | ğŸŸ¢ å¯æ¥å— |
| SHA256ï¼ˆ128ä½ï¼‰| â‰ˆ0% | ğŸŸ¢ è¿‡åº¦ä¿æŠ¤ |

**è®¡ç®—ä¾æ®ï¼š** P = 1 - e^(-n(n-1)/(2k))
- n = 1000ï¼ˆç¼“å­˜é¡¹æ•°ï¼‰
- k = 2^bitsï¼ˆå“ˆå¸Œç©ºé—´ï¼‰

### 3.3 å®é™…åœºæ™¯ä¼°ç®—

**NebulaæŸ¥è¯¢ç‰¹ç‚¹ï¼š**
- å…¸å‹æŸ¥è¯¢é•¿åº¦ï¼š50-500å­—ç¬¦
- æ¯ä¸ªé¡¹ç›®é€šå¸¸æ‰§è¡Œï¼š50-200ä¸ªä¸åŒæŸ¥è¯¢
- é›†ç¾¤ä¸­å¹¶å‘æŸ¥è¯¢ï¼š100-1000

**ç®€å•å“ˆå¸Œçš„é—®é¢˜ï¼š**
```
é¡¹ç›®1: SELECT * FROM users WHERE id=$id
é¡¹ç›®2: SELECT * FROM users WHERE id=$id
      â†’ å¦‚æœå‚æ•°ä¸åŒï¼Œä»å¯èƒ½äº§ç”Ÿå“ˆå¸Œç¢°æ’
      â†’ ç¼“å­˜è¿”å›é”™è¯¯æ•°æ®

é£é™©: æ¯1000æ¬¡ä¸åŒæŸ¥è¯¢ä¸­ï¼Œçº¦36æ¬¡ä¼šç¢°æ’
```

**FNV-1açš„ä¿éšœï¼š**
```
ç›¸åŒæ¦‚ç‡: <0.01%
æœŸæœ›æ— ç¢°æ’æ¬¡æ•°: >10,000,000 æ¬¡æŸ¥è¯¢
```

---

## 4. é€‰æ‹© FNV-1a çš„ç†ç”±

### 4.1 ç»¼åˆè¯„åˆ†

| æ–¹æ¡ˆ | ç¢°æ’å®‰å…¨ | æ€§èƒ½ | ç©ºé—´ | ä»£ç å¤ç”¨ | æ€»ä½“é€‚é… |
|------|--------|------|------|--------|--------|
| ç®€å•å“ˆå¸Œ | 1/5 ğŸ”´ | 5/5 ğŸŸ¢ | 5/5 ğŸŸ¢ | 5/5 ğŸŸ¢ | ä¸æ¨è |
| **FNV-1a** | **4/5 ğŸŸ¢** | **4/5 ğŸŸ¢** | **4/5 ğŸŸ¢** | **5/5 ğŸŸ¢** | **æ¨è** |
| SHA256 | 5/5 ğŸŸ¢ | 2/5 âš ï¸ | 2/5 âš ï¸ | 4/5 ğŸŸ¢ | è¿‡åº¦ |

### 4.2 FNV-1a ä¼˜åŠ¿

1. **å®‰å…¨æ€§å……åˆ†**
   - ç¢°æ’æ¦‚ç‡ <0.01% on 1000 items
   - æ»¡è¶³ç¼“å­˜åœºæ™¯éœ€æ±‚

2. **æ€§èƒ½ä¼˜å¼‚**
   - è®¡ç®—é€Ÿåº¦æ¯” SHA256 å¿« 5-10 å€
   - é€‚åˆé¢‘ç¹è°ƒç”¨ï¼ˆæ¯æ¬¡ç¼“å­˜æŸ¥è¯¢ï¼‰

3. **ç©ºé—´é«˜æ•ˆ**
   - 36è¿›åˆ¶è¾“å‡º 8-10 ä½
   - æ¯” SHA256 çš„ 50+ ä½èŠ‚çœ 80%

4. **å·¥å…·ç±»å¤ç”¨**
   - `HashUtils.fnv1aHash()` å·²åœ¨å·¥ç¨‹ä¸­éªŒè¯
   - ä»£ç å¤ç”¨ï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬

5. **å‡åŒ€åˆ†å¸ƒ**
   - 32ä½å“ˆå¸Œç©ºé—´ï¼Œåˆ†å¸ƒæ¥è¿‘ç†æƒ³
   - é¿å…ç®€å•å“ˆå¸Œçš„å±€éƒ¨èšé›†

---

## 5. è¡¥å……ï¼šQueryCache ä¸ generateQueryHash çš„å…³ç³»

### 5.1 å½“å‰å®ç°

`QueryCache.generateKey()` ä½¿ç”¨ **MD5** ç”Ÿæˆç¼“å­˜é”®ï¼š

```typescript
private generateKey(query: string, params?: Record<string, any>): string {
  const normalizedQuery = query.trim().replace(/\s+/g, ' ').toLowerCase();
  
  if (params && Object.keys(params).length > 0) {
    const sortedParams = Object.keys(params)
      .sort()
      .reduce((result, key) => {
        result[key] = params[key];
        return result;
      }, {} as Record<string, any>);
    
    const paramString = JSON.stringify(sortedParams);
    const combined = `${normalizedQuery}:${paramString}`;
    return this.config.keyPrefix + crypto.createHash('md5').update(combined).digest('hex');
  }
  
  return this.config.keyPrefix + crypto.createHash('md5').update(normalizedQuery).digest('hex');
}
```

### 5.2 MD5 vs FNV-1a

| æ–¹é¢ | MD5 | FNV-1a |
|------|-----|--------|
| ç”¨é€” | å½“å‰ç¼“å­˜é”®ç”Ÿæˆ | ä¸ºæœªæ¥ä¼˜åŒ–é¢„ç•™ |
| ç¢°æ’æ¦‚ç‡ | æä½ï¼ˆ128ä½ï¼‰ | ä½ï¼ˆ32ä½ï¼‰ |
| é€Ÿåº¦ | è¾ƒæ…¢ | å¿« |
| é€‚é…åº¦ | å®Œç¾ | é€‚é… |

### 5.3 å»ºè®®

- **ç°çŠ¶ä¿æŒä¸å˜**ï¼šQueryCache ç»§ç»­ä½¿ç”¨ MD5
- **generateQueryHash æ”¹ä¸º FNV-1a**ï¼šä¸ºæœªæ¥ç›´æ¥ä½¿ç”¨å“ˆå¸Œå€¼ç¼“å­˜é¢„ç•™ä¼˜åŒ–ç©ºé—´
- **ä¼˜åŠ¿**ï¼šå¦‚æœåç»­ä¼˜åŒ–æ”¹ç”¨ FNV-1aï¼Œ`generateQueryHash()` å·²å°±ä½

---

## 6. æ€»ç»“

### æœ€ç»ˆæ¨èæ–¹æ¡ˆ

âœ… **é‡‡ç”¨ FNV-1a ç®—æ³•ï¼ˆå·²å®æ–½ï¼‰**

### å…³é”®ç»“è®º

1. **å®¹å¿åº¦åˆ†æ**ï¼š
   - QueryRunner éœ€è¦**ä¸­ç­‰æŠ—ç¢°æ’èƒ½åŠ›**
   - ç®€å•å“ˆå¸Œï¼ˆ36%ç¢°æ’ç‡ï¼‰ä¸å¯æ¥å—
   - FNV-1aï¼ˆ<0.01%ç¢°æ’ç‡ï¼‰å®Œå…¨æ»¡è¶³

2. **ç®—æ³•é€‰æ‹©**ï¼š
   - ä¸é€‰ SHA256ï¼šè¿‡åº¦ä¿æŠ¤ï¼Œæ€§èƒ½æµªè´¹
   - é€‰æ‹© FNV-1aï¼šå®‰å…¨ã€å¿«é€Ÿã€ç©ºé—´é«˜æ•ˆ
   - å¤ç”¨å·¥å…·ç±»ï¼šä»£ç ä¸€è‡´ï¼Œç»´æŠ¤æˆæœ¬ä½

3. **æ”¹è¿›æ•ˆæœ**ï¼š
   - ç¢°æ’ç‡ä» ~36% â†’ <0.01%
   - æ€§èƒ½ä¿æŒåœ¨æœ€ä¼˜æ°´å¹³
   - ä»£ç å¤ç”¨åº¦æå‡

### éªŒè¯æ–¹æ³•

æµ‹è¯•ç¢°æ’ç‡ï¼ˆå¯é€‰ï¼‰ï¼š
```typescript
const queries = generateRandomQueries(10000);
const hashes = new Set<string>();
let collisions = 0;

for (const query of queries) {
  const hash = HashUtils.fnv1aHash(query);
  if (hashes.has(hash)) {
    collisions++;
  }
  hashes.add(hash);
}

console.log(`ç¢°æ’ç‡: ${(collisions / 10000 * 100).toFixed(4)}%`);
// é¢„æœŸ: <0.01%
```
