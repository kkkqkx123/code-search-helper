# Parseræ¨¡å—æ›´æ–°å·¥ä½œæµåˆ†æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ¢³ç†äº†src\service\parserç›®å½•ä¸­parseræ¨¡å—çš„æ•´ä½“å·¥ä½œæµï¼Œæ›´æ–°äº†è¿‡æ—¶çš„åˆ†æå†…å®¹ï¼Œç‰¹åˆ«æ˜¯ç®€åŒ–åçš„å›é€€æœºåˆ¶å¤„ç†ã€‚

## ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶æ¶æ„

### 1. æ ¸å¿ƒè§£æå±‚ (Core Parsing Layer)

#### TreeSitterCoreService
- **èŒè´£**: ç»Ÿä¸€å…¥å£ï¼Œåè°ƒè§£æå’ŒæŸ¥è¯¢åŠŸèƒ½
- **å…³é”®æ–¹æ³•**:
  - `parseCode()`: è§£æä»£ç å¹¶è¿”å›AST
  - `parseFile()`: è§£ææ–‡ä»¶å¹¶è‡ªåŠ¨æ£€æµ‹è¯­è¨€
  - `findNodeByType()`: åŒæ­¥èŠ‚ç‚¹æŸ¥æ‰¾ï¼ˆä½¿ç”¨FallbackExtractorï¼‰
  - `findNodeByTypeAsync()`: å¼‚æ­¥èŠ‚ç‚¹æŸ¥æ‰¾ï¼ˆä¼˜å…ˆä½¿ç”¨TreeSitterQueryFacadeï¼‰

#### DynamicParserManager
- **èŒè´£**: åŠ¨æ€è§£æå™¨ç®¡ç†ï¼ŒæŒ‰éœ€åŠ è½½è¯­è¨€è§£æå™¨
- **å…³é”®ç‰¹æ€§**:
  - å¤šçº§ç¼“å­˜ï¼šè§£æå™¨ç¼“å­˜(LRU-50)ã€ASTç¼“å­˜(LRU-500)ã€èŠ‚ç‚¹ç¼“å­˜(LRU-1000)
  - åŠ¨æ€è¯­è¨€åŠ è½½å™¨æœºåˆ¶
  - æ€§èƒ½ç»Ÿè®¡å’Œç›‘æ§

### 2. æŸ¥è¯¢ç³»ç»Ÿå±‚ (Query System Layer)

#### TreeSitterQueryFacade
- **èŒè´£**: ç®€åŒ–æŸ¥è¯¢å¼•æ“ï¼Œæä¾›æ˜“ç”¨çš„æŸ¥è¯¢æ¥å£
- **å…³é”®æ–¹æ³•**:
  - `findFunctions()`, `findClasses()`, `findImports()`, `findExports()`
  - `findMultiple()`: æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
  - `findAllMainStructures()`: æŸ¥æ‰¾æ‰€æœ‰ä¸»è¦ç»“æ„

#### QueryManager & QueryRegistry
- **èŒè´£**: æŸ¥è¯¢æ¨¡å¼ç®¡ç†å’Œæ‰§è¡Œ
- **å…³é”®ç‰¹æ€§**:
  - æŸ¥è¯¢ç¼“å­˜(LRU-100)å’Œæ¨¡å¼ç¼“å­˜(LRU-50)
  - æ”¯æŒå¤šç§æŸ¥è¯¢ç±»å‹
  - å…¨å±€åˆå§‹åŒ–ç®¡ç†

#### GlobalQueryInitializer
- **èŒè´£**: ç¡®ä¿æŸ¥è¯¢ç³»ç»Ÿåªåˆå§‹åŒ–ä¸€æ¬¡
- **å…³é”®ç‰¹æ€§**:
  - é¿å…é‡å¤åŠ è½½
  - çŠ¶æ€ç®¡ç†å’ŒåŒæ­¥

### 3. å›é€€æœºåˆ¶å±‚ (Fallback Layer)

#### FallbackExtractor
- **èŒè´£**: æ™ºèƒ½å›é€€æå–å™¨ï¼Œå½“æŸ¥è¯¢å¤±è´¥æ—¶æä¾›å›é€€æœºåˆ¶
- **å…³é”®ç‰¹æ€§**:
  - ä¼˜å…ˆä½¿ç”¨ç°æœ‰æŸ¥è¯¢ç³»ç»Ÿ
  - è¯­è¨€æ„ŸçŸ¥çš„èŠ‚ç‚¹æå–
  - ç‰¹æ®Šè¯­è¨€å¤„ç†ï¼ˆè·³è¿‡ä¸æ”¯æŒçš„æå–ç±»å‹ï¼‰

### 4. å¤„ç†åè°ƒå±‚ (Processing Coordination Layer)

#### UnifiedProcessingCoordinator
- **èŒè´£**: ç»Ÿä¸€å¤„ç†åè°ƒå™¨ï¼Œæ•´åˆæ–‡ä»¶å¤„ç†æµç¨‹
- **å…³é”®ç‰¹æ€§**:
  - ä¿æŠ¤æœºåˆ¶æ£€æŸ¥ï¼ˆå†…å­˜é™åˆ¶ã€é”™è¯¯é˜ˆå€¼ï¼‰
  - ç­–ç•¥é€‰æ‹©å’Œæ‰§è¡Œ
  - æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

#### UnifiedDetectionService
- **èŒè´£**: ç»Ÿä¸€æ£€æµ‹æœåŠ¡ï¼Œæ™ºèƒ½æ–‡ä»¶æ£€æµ‹å’Œè¯­è¨€è¯†åˆ«
- **å…³é”®ç‰¹æ€§**:
  - å¤šç§æ£€æµ‹æ–¹æ³•ï¼šæ‰©å±•åã€å†…å®¹ã€å¤‡ä»½æ–‡ä»¶
  - æ–‡ä»¶ç‰¹å¾åˆ†æ
  - å¤„ç†ç­–ç•¥æ¨è

#### UnifiedStrategyManager
- **èŒè´£**: ç»Ÿä¸€ç­–ç•¥ç®¡ç†å™¨ï¼Œç®¡ç†å„ç§åˆ†æ®µç­–ç•¥
- **å…³é”®ç‰¹æ€§**:
  - æ™ºèƒ½ç­–ç•¥é€‰æ‹©
  - é™çº§è·¯å¾„ç®¡ç†
  - æ€§èƒ½ç»Ÿè®¡å’Œç¼“å­˜

## ğŸ”„ æ•´ä½“å·¥ä½œæµç¨‹

### ä¸»è¦å¤„ç†æµç¨‹

```mermaid
graph TD
    A[æ–‡ä»¶è¾“å…¥] --> B[UnifiedProcessingCoordinator.processFile]
    B --> C[ä¿æŠ¤æœºåˆ¶æ£€æŸ¥]
    C --> D{å†…å­˜é™åˆ¶æ£€æŸ¥}
    D -->|è¶…å‡ºé™åˆ¶| E[æ‰§è¡Œé™çº§å¤„ç†]
    D -->|æ­£å¸¸| F[UnifiedDetectionService.detectFile]
    
    F --> G[å¤‡ä»½æ–‡ä»¶æ£€æµ‹]
    G --> H[æ‰©å±•åè¯­è¨€æ£€æµ‹]
    H --> I[å†…å®¹è¯­è¨€æ£€æµ‹]
    I --> J[æ™ºèƒ½å†³ç­–]
    J --> K[æ–‡ä»¶ç‰¹å¾åˆ†æ]
    K --> L[ASTç”Ÿæˆ?]
    L -->|æ˜¯| M[TreeSitterCoreService.parseCode]
    L -->|å¦| N[æ¨èå¤„ç†ç­–ç•¥]
    
    M --> O[DynamicParserManager.parseCode]
    O --> P[è§£æå™¨ç¼“å­˜æ£€æŸ¥]
    P --> Q[ASTç¼“å­˜æ£€æŸ¥]
    Q --> R[ç”ŸæˆAST]
    
    N --> S[UnifiedStrategyManager.selectOptimalStrategy]
    S --> T[ç­–ç•¥æ‰§è¡Œ]
    T --> U{æ‰§è¡ŒæˆåŠŸ?}
    U -->|å¦| V[é™çº§ç­–ç•¥é€‰æ‹©]
    V --> W[æ‰§è¡Œé™çº§ç­–ç•¥]
    U -->|æ˜¯| X[è¿”å›å¤„ç†ç»“æœ]
    
    E --> Y[UnifiedGuardCoordinator.processFileWithDetection]
    Y --> Z[ç´§æ€¥å¤„ç†ç»“æœ]
    W --> X
    X --> AA[æ›´æ–°ç»Ÿè®¡ä¿¡æ¯]
    AA --> AB[è¿”å›æœ€ç»ˆç»“æœ]
```

### æŸ¥è¯¢æ‰§è¡Œæµç¨‹

```mermaid
graph TD
    A[æŸ¥è¯¢è¯·æ±‚] --> B{æŸ¥è¯¢ç³»ç»Ÿåˆå§‹åŒ–?}
    B -->|å¦| C[GlobalQueryInitializer.initialize]
    B -->|æ˜¯| D[TreeSitterQueryFacadeæŸ¥è¯¢]
    C --> D
    
    D --> E[æŸ¥è¯¢ç¼“å­˜æ£€æŸ¥]
    E -->|å‘½ä¸­| F[è¿”å›ç¼“å­˜ç»“æœ]
    E -->|æœªå‘½ä¸­| G[QueryEngineFactory.executeQuery]
    
    G --> H{æŸ¥è¯¢æˆåŠŸ?}
    H -->|æ˜¯| I[ç¼“å­˜ç»“æœ]
    H -->|å¦| J[FallbackExtractorå›é€€]
    
    J --> K[è¯­è¨€ç‰¹å®šæŸ¥è¯¢å°è¯•]
    K --> L{æˆåŠŸ?}
    L -->|æ˜¯| M[è¿”å›ç»“æœ]
    L -->|å¦| N[é€šç”¨èŠ‚ç‚¹ç±»å‹éå†]
    
    I --> M
    N --> M
    F --> M
    M --> O[è¿”å›æŸ¥è¯¢ç»“æœ]
```

## ğŸ›¡ï¸ ç®€åŒ–çš„å›é€€æœºåˆ¶

### å›é€€å±‚æ¬¡ç»“æ„

1. **æŸ¥è¯¢ç³»ç»Ÿå›é€€**
   - TreeSitterQueryFacade â†’ FallbackExtractor
   - ä¼˜å…ˆä½¿ç”¨è¯­è¨€ç‰¹å®šæŸ¥è¯¢
   - å¤±è´¥æ—¶ä½¿ç”¨é€šç”¨èŠ‚ç‚¹éå†

2. **ç­–ç•¥æ‰§è¡Œå›é€€**
   - é«˜çº§ç­–ç•¥ â†’ ä¸­çº§ç­–ç•¥ â†’ åŸºç¡€ç­–ç•¥ â†’ ç´§æ€¥ç­–ç•¥
   - æ™ºèƒ½é™çº§è·¯å¾„é€‰æ‹©
   - æœ€å¤§é‡è¯•æ¬¡æ•°é™åˆ¶

3. **ç³»ç»Ÿä¿æŠ¤å›é€€**
   - å†…å­˜é™åˆ¶æ£€æŸ¥
   - é”™è¯¯é˜ˆå€¼ç›‘æ§
   - ç´§æ€¥å•å—å¤„ç†

### å›é€€ç­–ç•¥æ˜ å°„

| å½“å‰ç­–ç•¥ | é™çº§è·¯å¾„ |
|---------|---------|
| treesitter_ast | universal_semantic â†’ universal_semantic_fine â†’ universal_bracket â†’ universal_line |
| universal_semantic | universal_semantic_fine â†’ universal_bracket â†’ universal_line |
| universal_semantic_fine | universal_bracket â†’ universal_line |
| universal_bracket | universal_line |
| universal_line | minimal_fallback |

## ğŸ“Š å…³é”®å˜åŒ–å’Œæ”¹è¿›ç‚¹

### 1. æ¶æ„ç®€åŒ–
- **ç§»é™¤å¤æ‚çš„å›é€€é€»è¾‘**: ç®€åŒ–äº†TreeSitterUtilsçš„èŒè´£ï¼Œä¸“æ³¨äºåŸºç¡€å·¥å…·æ–¹æ³•
- **ç»Ÿä¸€å›é€€å¤„ç†**: FallbackExtractorä½œä¸ºç»Ÿä¸€çš„å›é€€å…¥å£
- **å‡å°‘é‡å¤ä»£ç **: é€šè¿‡TreeSitterQueryFacadeçš„é€šç”¨æŸ¥è¯¢æ–¹æ³•å‡å°‘é‡å¤

### 2. æ€§èƒ½ä¼˜åŒ–
- **å¤šçº§ç¼“å­˜ç³»ç»Ÿ**: è§£æå™¨ã€ASTã€èŠ‚ç‚¹ã€æŸ¥è¯¢å››çº§ç¼“å­˜
- **å¹¶è¡Œå¤„ç†æ”¯æŒ**: æ‰¹é‡æŸ¥è¯¢å’Œæ–‡ä»¶å¤„ç†çš„å¹¶è¡Œæ‰§è¡Œ
- **æ™ºèƒ½ç¼“å­˜ç­–ç•¥**: åŸºäºä½¿ç”¨é¢‘ç‡å’Œå†…å­˜é™åˆ¶çš„ç¼“å­˜ç®¡ç†

### 3. é”™è¯¯å¤„ç†å¢å¼º
- **åˆ†å±‚é”™è¯¯å¤„ç†**: ä»æŸ¥è¯¢çº§åˆ°ç³»ç»Ÿçº§çš„å®Œæ•´é”™è¯¯å¤„ç†é“¾
- **æ™ºèƒ½é™çº§**: åŸºäºé”™è¯¯ç±»å‹å’Œç³»ç»ŸçŠ¶æ€çš„æ™ºèƒ½é™çº§é€‰æ‹©
- **ä¿æŠ¤æœºåˆ¶**: å†…å­˜é™åˆ¶å’Œé”™è¯¯é˜ˆå€¼ä¿æŠ¤

### 4. æ‰©å±•æ€§æ”¹è¿›
- **æ’ä»¶åŒ–ç­–ç•¥**: å¯æ’æ‹”çš„åˆ†æ®µç­–ç•¥å®ç°
- **åŠ¨æ€è¯­è¨€åŠ è½½**: æŒ‰éœ€åŠ è½½è¯­è¨€è§£æå™¨
- **é…ç½®é©±åŠ¨**: ç»Ÿä¸€é…ç½®ç®¡ç†ç³»ç»Ÿ

## ğŸ”§ é…ç½®å’Œè°ƒä¼˜

### å…³é”®é…ç½®å‚æ•°

```typescript
// ç¼“å­˜é…ç½®
parserCacheSize: 50-100        // è§£æå™¨ç¼“å­˜å¤§å°
astCacheSize: 500-1000         // ASTç¼“å­˜å¤§å°  
queryCacheSize: 100-200        // æŸ¥è¯¢ç¼“å­˜å¤§å°
nodeCacheSize: 1000            // èŠ‚ç‚¹ç¼“å­˜å¤§å°

// æ€§èƒ½é…ç½®
maxWaitTime: 10000             // æœ€å¤§ç­‰å¾…æ—¶é—´(ms)
maxRetries: 3                  // æœ€å¤§é‡è¯•æ¬¡æ•°
memoryLimitMB: 1024            // å†…å­˜é™åˆ¶(MB)
enableParallel: true           // å¯ç”¨å¹¶è¡Œå¤„ç†

// åˆ†æ®µé…ç½®
maxChunkSize: 2000             // æœ€å¤§å—å¤§å°(å­—ç¬¦)
overlapSize: 200               // é‡å å¤§å°(å­—ç¬¦)
maxLinesPerChunk: 100          // æ¯å—æœ€å¤§è¡Œæ•°
```

### æ€§èƒ½ç›‘æ§æŒ‡æ ‡

- **ç¼“å­˜å‘½ä¸­ç‡**: å„çº§ç¼“å­˜çš„å‘½ä¸­ç‡ç»Ÿè®¡
- **è§£ææ€§èƒ½**: å¹³å‡è§£ææ—¶é—´å’ŒæˆåŠŸç‡
- **æŸ¥è¯¢æ€§èƒ½**: æŸ¥è¯¢æ‰§è¡Œæ—¶é—´å’ŒæˆåŠŸç‡
- **å†…å­˜ä½¿ç”¨**: å®æ—¶å†…å­˜ä½¿ç”¨ç›‘æ§
- **é”™è¯¯ç»Ÿè®¡**: é”™è¯¯ç±»å‹å’Œé¢‘ç‡ç»Ÿè®¡

## ğŸ“ˆ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬è§£ææµç¨‹

```typescript
// 1. åˆ›å»ºæ ¸å¿ƒæœåŠ¡
const coreService = new TreeSitterCoreService();

// 2. è§£ææ–‡ä»¶
const result = await coreService.parseFile(filePath, content);

// 3. æå–ç»“æ„
const functions = await coreService.findNodeByTypeAsync(result.ast, 'function_declaration');
const classes = await coreService.findNodeByTypeAsync(result.ast, 'class_declaration');
```

### æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

```typescript
// ä½¿ç”¨TreeSitterQueryFacadeè¿›è¡Œæ‰¹é‡æŸ¥è¯¢
const structures = await TreeSitterQueryFacade.findAllMainStructures(ast, language);

// æˆ–ä½¿ç”¨è‡ªå®šä¹‰æ‰¹é‡æŸ¥è¯¢
const customResults = await TreeSitterQueryFacade.findMultiple(
  ast, 
  language, 
  ['functions', 'classes', 'imports', 'exports', 'interfaces']
);
```

### å¤„ç†åè°ƒæµç¨‹

```typescript
// ä½¿ç”¨ç»Ÿä¸€å¤„ç†åè°ƒå™¨
const coordinator = new UnifiedProcessingCoordinator(
  strategyManager,
  detectionService,
  configManager,
  guardCoordinator,
  performanceMonitor,
  configCoordinator,
  segmentationCoordinator
);

const result = await coordinator.processFile({
  filePath: 'example.ts',
  content: fileContent,
  options: {
    basic: {
      maxChunkSize: 2000,
      overlapSize: 200,
      maxLines: 100
    }
  }
});
```

## ğŸ¯ æ€»ç»“

Parseræ¨¡å—ç»è¿‡é‡æ„åï¼Œå½¢æˆäº†æ¸…æ™°çš„åˆ†å±‚æ¶æ„å’Œç®€åŒ–çš„å›é€€æœºåˆ¶ã€‚ä¸»è¦æ”¹è¿›åŒ…æ‹¬ï¼š

1. **æ¶æ„æ¸…æ™°åŒ–**: æ˜ç¡®çš„èŒè´£åˆ†ç¦»å’Œæ¨¡å—åŒ–è®¾è®¡
2. **å›é€€ç®€åŒ–**: ç»Ÿä¸€çš„å›é€€å…¥å£å’Œæ™ºèƒ½é™çº§ç­–ç•¥
3. **æ€§èƒ½ä¼˜åŒ–**: å¤šçº§ç¼“å­˜å’Œå¹¶è¡Œå¤„ç†æ”¯æŒ
4. **é”™è¯¯å¤„ç†**: å®Œæ•´çš„é”™è¯¯å¤„ç†é“¾å’Œä¿æŠ¤æœºåˆ¶
5. **æ‰©å±•æ€§**: æ’ä»¶åŒ–ç­–ç•¥å’ŒåŠ¨æ€è¯­è¨€æ”¯æŒ

è¿™äº›æ”¹è¿›ä½¿å¾—parseræ¨¡å—æ›´åŠ ç¨³å®šã€é«˜æ•ˆå’Œæ˜“äºç»´æŠ¤ï¼Œä¸ºä»£ç åº“ç´¢å¼•å’Œæ£€ç´¢æä¾›äº†åšå®çš„åŸºç¡€ã€‚