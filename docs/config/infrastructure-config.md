# 基础设施配置

## 概述

基础设施配置用于控制应用程序底层基础设施服务的各个方面，包括缓存、监控、批处理、连接池等。这些配置通常具有前缀`INFRA_`，并细分为通用、Qdrant、Nebula等特定服务的配置。

## 配置项说明

### 通用基础设施配置

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `INFRA_COMMON_ENABLE_CACHE` | `true` | 是否启用通用缓存 |
| `INFRA_COMMON_ENABLE_MONITORING` | `true` | 是否启用通用监控 |
| `INFRA_COMMON_ENABLE_BATCHING` | `true` | 是否启用批处理 |
| `INFRA_COMMON_LOG_LEVEL` | `info` | 通用基础设施日志级别 |
| `INFRA_COMMON_ENABLE_HEALTH_CHECKS` | `true` | 是否启用健康检查 |
| `INFRA_COMMON_HEALTH_CHECK_INTERVAL` | `300` | 健康检查间隔（毫秒） |
| `INFRA_COMMON_GRACEFUL_SHUTDOWN_TIMEOUT` | `10000` | 优雅关闭超时时间（毫秒） |

### Qdrant基础设施配置

#### Qdrant缓存配置
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `INFRA_QDRANT_CACHE_DEFAULT_TTL` | `3000` | Qdrant缓存默认TTL（毫秒） |
| `INFRA_QDRANT_CACHE_MAX_ENTRIES` | `100` | Qdrant缓存最大条目数 |
| `INFRA_QDRANT_CACHE_CLEANUP_INTERVAL` | `600` | Qdrant缓存清理间隔（毫秒） |
| `INFRA_QDRANT_CACHE_ENABLE_STATS` | `true` | 是否启用Qdrant缓存统计 |

#### Qdrant性能配置
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `INFRA_QDRANT_PERFORMANCE_MONITORING_INTERVAL` | `300` | Qdrant性能监控间隔（秒） |
| `INFRA_QDRANT_PERFORMANCE_METRICS_RETENTION_PERIOD` | `8640000` | Qdrant性能指标保留周期（毫秒） |
| `INFRA_QDRANT_PERFORMANCE_ENABLE_DETAILED_LOGGING` | `true` | 是否启用Qdrant详细日志 |
| `INFRA_QDRANT_PERFORMANCE_QUERY_EXECUTION_TIME` | `1000` | Qdrant查询执行时间阈值（毫秒） |
| `INFRA_QDRANT_PERFORMANCE_MEMORY_USAGE` | `80` | Qdrant内存使用阈值（%） |
| `INFRA_QDRANT_PERFORMANCE_RESPONSE_TIME` | `500` | Qdrant响应时间阈值（毫秒） |

#### Qdrant批处理配置
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `INFRA_QDRANT_BATCH_MAX_CONCURRENT_OPERATIONS` | `5` | Qdrant最大并发操作数 |
| `INFRA_QDRANT_BATCH_DEFAULT_BATCH_SIZE` | `50` | Qdrant默认批处理大小 |
| `INFRA_QDRANT_BATCH_MAX_BATCH_SIZE` | `500` | Qdrant最大批处理大小 |
| `INFRA_QDRANT_BATCH_MIN_BATCH_SIZE` | `10` | Qdrant最小批处理大小 |
| `INFRA_QDRANT_BATCH_MEMORY_THRESHOLD` | `80` | Qdrant批处理内存阈值（%） |
| `INFRA_QDRANT_BATCH_PROCESSING_TIMEOUT` | `3000` | Qdrant批处理处理超时（毫秒） |
| `INFRA_QDRANT_BATCH_RETRY_ATTEMPTS` | `3` | Qdrant批处理重试次数 |
| `INFRA_QDRANT_BATCH_RETRY_DELAY` | `1000` | Qdrant批处理重试延迟（毫秒） |
| `INFRA_QDRANT_BATCH_ADAPTIVE_BATCHING_ENABLED` | `true` | 是否启用Qdrant自适应批处理 |
| `INFRA_QDRANT_BATCH_PERFORMANCE_THRESHOLD` | `1000` | Qdrant批处理性能阈值 |
| `INFRA_QDRANT_BATCH_ADJUSTMENT_FACTOR` | `0.1` | Qdrant批处理调整因子 |

#### Qdrant连接配置
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `INFRA_QDRANT_CONNECTION_MAX_CONNECTIONS` | `10` | Qdrant最大连接数 |
| `INFRA_QDRANT_CONNECTION_MIN_CONNECTIONS` | `2` | Qdrant最小连接数 |
| `INFRA_QDRANT_CONNECTION_CONNECTION_TIMEOUT` | `30000` | Qdrant连接超时（毫秒） |
| `INFRA_QDRANT_CONNECTION_IDLE_TIMEOUT` | `300000` | Qdrant空闲连接超时（毫秒） |
| `INFRA_QDRANT_CONNECTION_ACQUIRE_TIMEOUT` | `1000` | Qdrant连接获取超时（毫秒） |
| `INFRA_QDRANT_CONNECTION_VALIDATION_INTERVAL` | `6000` | Qdrant连接验证间隔（毫秒） |
| `INFRA_QDRANT_CONNECTION_ENABLE_CONNECTION_POOLING` | `true` | 是否启用Qdrant连接池 |

#### Qdrant向量配置
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `INFRA_QDRANT_VECTOR_DEFAULT_COLLECTION` | `default` | Qdrant默认集合名称 |
| `INFRA_QDRANT_VECTOR_COLLECTION_VECTOR_SIZE` | `1536` | Qdrant集合向量大小 |
| `INFRA_QDRANT_VECTOR_COLLECTION_DISTANCE` | `Cosine` | Qdrant集合距离类型 |
| `INFRA_QDRANT_VECTOR_COLLECTION_INDEXING_TYPE` | `hnsw` | Qdrant集合索引类型 |
| `INFRA_QDRANT_VECTOR_SEARCH_LIMIT` | `10` | Qdrant搜索限制 |
| `INFRA_QDRANT_VECTOR_SEARCH_THRESHOLD` | `0.5` | Qdrant搜索阈值 |
| `INFRA_QDRANT_VECTOR_SEARCH_EXACT_SEARCH` | `false` | 是否启用Qdrant精确搜索 |

### Nebula基础设施配置

#### Nebula缓存配置
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `INFRA_NEBULA_CACHE_DEFAULT_TTL` | `3000` | Nebula缓存默认TTL（毫秒） |
| `INFRA_NEBULA_CACHE_MAX_ENTRIES` | `10000` | Nebula缓存最大条目数 |
| `INFRA_NEBULA_CACHE_CLEANUP_INTERVAL` | `6000` | Nebula缓存清理间隔（毫秒） |
| `INFRA_NEBULA_CACHE_ENABLE_STATS` | `true` | 是否启用Nebula缓存统计 |

#### Nebula性能配置
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `INFRA_NEBULA_PERFORMANCE_MONITORING_INTERVAL` | `300` | Nebula性能监控间隔（毫秒） |
| `INFRA_NEBULA_PERFORMANCE_METRICS_RETENTION_PERIOD` | `86400` | Nebula性能指标保留周期（毫秒） |
| `INFRA_NEBULA_PERFORMANCE_ENABLE_DETAILED_LOGGING` | `true` | 是否启用Nebula详细日志 |
| `INFRA_NEBULA_PERFORMANCE_QUERY_EXECUTION_TIME` | `1000` | Nebula查询执行时间阈值（毫秒） |
| `INFRA_NEBULA_PERFORMANCE_MEMORY_USAGE` | `80` | Nebula内存使用阈值（%） |
| `INFRA_NEBULA_PERFORMANCE_RESPONSE_TIME` | `500` | Nebula响应时间阈值（毫秒） |

#### Nebula批处理配置
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `INFRA_NEBULA_BATCH_MAX_CONCURRENT_OPERATIONS` | `5` | Nebula最大并发操作数 |
| `INFRA_NEBULA_BATCH_DEFAULT_BATCH_SIZE` | `50` | Nebula默认批处理大小 |
| `INFRA_NEBULA_BATCH_MAX_BATCH_SIZE` | `500` | Nebula最大批处理大小 |
| `INFRA_NEBULA_BATCH_MIN_BATCH_SIZE` | `10` | Nebula最小批处理大小 |
| `INFRA_NEBULA_BATCH_MEMORY_THRESHOLD` | `80` | Nebula批处理内存阈值（%） |
| `INFRA_NEBULA_BATCH_PROCESSING_TIMEOUT` | `300000` | Nebula批处理处理超时（毫秒） |
| `INFRA_NEBULA_BATCH_RETRY_ATTEMPTS` | `3` | Nebula批处理重试次数 |
| `INFRA_NEBULA_BATCH_RETRY_DELAY` | `1000` | Nebula批处理重试延迟（毫秒） |
| `INFRA_NEBULA_BATCH_ADAPTIVE_BATCHING_ENABLED` | `true` | 是否启用Nebula自适应批处理 |
| `INFRA_NEBULA_BATCH_PERFORMANCE_THRESHOLD` | `1000` | Nebula批处理性能阈值 |
| `INFRA_NEBULA_BATCH_ADJUSTMENT_FACTOR` | `0.1` | Nebula批处理调整因子 |

#### Nebula连接配置
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `INFRA_NEBULA_CONNECTION_MAX_CONNECTIONS` | `10` | Nebula最大连接数 |
| `INFRA_NEBULA_CONNECTION_MIN_CONNECTIONS` | `2` | Nebula最小连接数 |
| `INFRA_NEBULA_CONNECTION_CONNECTION_TIMEOUT` | `30000` | Nebula连接超时（毫秒） |
| `INFRA_NEBULA_CONNECTION_IDLE_TIMEOUT` | `300000` | Nebula空闲连接超时（毫秒） |
| `INFRA_NEBULA_CONNECTION_ACQUIRE_TIMEOUT` | `10000` | Nebula连接获取超时（毫秒） |
| `INFRA_NEBULA_CONNECTION_VALIDATION_INTERVAL` | `60000` | Nebula连接验证间隔（毫秒） |
| `INFRA_NEBULA_CONNECTION_ENABLE_CONNECTION_POOLING` | `true` | 是否启用Nebula连接池 |

#### Nebula图配置
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `INFRA_NEBULA_GRAPH_DEFAULT_SPACE` | `default` | Nebula默认空间名称 |
| `INFRA_NEBULA_GRAPH_SPACE_PARTITION_NUM` | `10` | Nebula空间分区数 |
| `INFRA_NEBULA_GRAPH_SPACE_REPLICA_FACTOR` | `1` | Nebula空间副本因子 |
| `INFRA_NEBULA_GRAPH_SPACE_VID_TYPE` | `FIXED_STRING` | Nebula空间VID类型 |
| `INFRA_NEBULA_GRAPH_QUERY_TIMEOUT` | `3000` | Nebula查询超时（毫秒） |
| `INFRA_NEBULA_GRAPH_QUERY_RETRY_ATTEMPTS` | `3` | Nebula查询重试次数 |
| `INFRA_NEBULA_GRAPH_SCHEMA_AUTO_CREATE_TAGS` | `false` | 是否自动创建Nebula标签 |
| `INFRA_NEBULA_GRAPH_SCHEMA_AUTO_CREATE_EDGES` | `false` | 是否自动创建Nebula边 |

### 事务配置
| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `INFRA_TRANSACTION_TIMEOUT` | `3000` | 事务超时时间（毫秒） |
| `INFRA_TRANSACTION_RETRY_ATTEMPTS` | `3` | 事务重试次数 |
| `INFRA_TRANSACTION_RETRY_DELAY` | `1000` | 事务重试延迟（毫秒） |
| `INFRA_TRANSACTION_ENABLE_TWO_PHASE_COMMIT` | `true` | 是否启用两阶段提交 |
| `INFRA_TRANSACTION_MAX_CONCURRENT_TRANSACTIONS` | `100` | 最大并发事务数 |
| `INFRA_TRANSACTION_DEADLOCK_DETECTION_TIMEOUT` | `500` | 死锁检测超时（毫秒） |

## 使用这些配置项的文件

### 1. 基础设施配置服务
- **文件**: `ref/src/service/infrastructure/InfrastructureConfigService.ts` (可能在其他位置)
- **用途**: 管理基础设施配置参数，加载环境变量并验证配置

### 2. 基础设施管理器
- **文件**: `ref/src/service/infrastructure/InfrastructureManager.ts` (可能在其他位置)
- **用途**: 使用基础设施配置管理各种基础设施服务

### 3. 连接池管理器
- **文件**: `src/infrastructure/connection/DatabaseConnectionPool.ts`
- **用途**: 使用连接池配置管理数据库连接

### 4. 批处理优化器
- **文件**: `src/infrastructure/batching/BatchOptimizer.ts`
- **用途**: 使用批处理配置优化操作性能

## 配置验证

基础设施配置会在应用程序启动时进行验证，确保所有参数在合理范围内。

## 示例配置

```bash
# 通用基础设施配置
INFRA_COMMON_ENABLE_CACHE=true
INFRA_COMMON_ENABLE_MONITORING=true
INFRA_COMMON_ENABLE_BATCHING=true
INFRA_COMMON_LOG_LEVEL=info
INFRA_COMMON_ENABLE_HEALTH_CHECKS=true
INFRA_COMMON_HEALTH_CHECK_INTERVAL=30000
INFRA_COMMON_GRACEFUL_SHUTDOWN_TIMEOUT=10000

# Qdrant基础设施配置
INFRA_QDRANT_CACHE_DEFAULT_TTL=300000
INFRA_QDRANT_CACHE_MAX_ENTRIES=10000
INFRA_QDRANT_CACHE_CLEANUP_INTERVAL=60000
INFRA_QDRANT_CACHE_ENABLE_STATS=true
INFRA_QDRANT_PERFORMANCE_MONITORING_INTERVAL=30
INFRA_QDRANT_PERFORMANCE_METRICS_RETENTION_PERIOD=86400000
INFRA_QDRANT_PERFORMANCE_ENABLE_DETAILED_LOGGING=true
INFRA_QDRANT_PERFORMANCE_QUERY_EXECUTION_TIME=1000
INFRA_QDRANT_PERFORMANCE_MEMORY_USAGE=80
INFRA_QDRANT_PERFORMANCE_RESPONSE_TIME=500
INFRA_QDRANT_BATCH_MAX_CONCURRENT_OPERATIONS=5
INFRA_QDRANT_BATCH_DEFAULT_BATCH_SIZE=50
INFRA_QDRANT_BATCH_MAX_BATCH_SIZE=500
INFRA_QDRANT_BATCH_MIN_BATCH_SIZE=10
INFRA_QDRANT_BATCH_MEMORY_THRESHOLD=80
INFRA_QDRANT_BATCH_PROCESSING_TIMEOUT=300000
INFRA_QDRANT_BATCH_RETRY_ATTEMPTS=3
INFRA_QDRANT_BATCH_RETRY_DELAY=1000
INFRA_QDRANT_BATCH_ADAPTIVE_BATCHING_ENABLED=true
INFRA_QDRANT_BATCH_PERFORMANCE_THRESHOLD=1000
INFRA_QDRANT_BATCH_ADJUSTMENT_FACTOR=0.1
INFRA_QDRANT_CONNECTION_MAX_CONNECTIONS=10
INFRA_QDRANT_CONNECTION_MIN_CONNECTIONS=2
INFRA_QDRANT_CONNECTION_CONNECTION_TIMEOUT=30000
INFRA_QDRANT_CONNECTION_IDLE_TIMEOUT=3000
INFRA_QDRANT_CONNECTION_ACQUIRE_TIMEOUT=1000
INFRA_QDRANT_CONNECTION_VALIDATION_INTERVAL=6000
INFRA_QDRANT_CONNECTION_ENABLE_CONNECTION_POOLING=true
INFRA_QDRANT_VECTOR_DEFAULT_COLLECTION=default
INFRA_QDRANT_VECTOR_COLLECTION_VECTOR_SIZE=1536
INFRA_QDRANT_VECTOR_COLLECTION_DISTANCE=Cosine
INFRA_QDRANT_VECTOR_COLLECTION_INDEXING_TYPE=hnsw
INFRA_QDRANT_VECTOR_SEARCH_LIMIT=10
INFRA_QDRANT_VECTOR_SEARCH_THRESHOLD=0.5
INFRA_QDRANT_VECTOR_SEARCH_EXACT_SEARCH=false

# Nebula基础设施配置
INFRA_NEBULA_CACHE_DEFAULT_TTL=30000
INFRA_NEBULA_CACHE_MAX_ENTRIES=10000
INFRA_NEBULA_CACHE_CLEANUP_INTERVAL=60000
INFRA_NEBULA_CACHE_ENABLE_STATS=true
INFRA_NEBULA_PERFORMANCE_MONITORING_INTERVAL=30000
INFRA_NEBULA_PERFORMANCE_METRICS_RETENTION_PERIOD=8640000
INFRA_NEBULA_PERFORMANCE_ENABLE_DETAILED_LOGGING=true
INFRA_NEBULA_PERFORMANCE_QUERY_EXECUTION_TIME=1000
INFRA_NEBULA_PERFORMANCE_MEMORY_USAGE=80
INFRA_NEBULA_PERFORMANCE_RESPONSE_TIME=500
INFRA_NEBULA_BATCH_MAX_CONCURRENT_OPERATIONS=5
INFRA_NEBULA_BATCH_DEFAULT_BATCH_SIZE=50
INFRA_NEBULA_BATCH_MAX_BATCH_SIZE=500
INFRA_NEBULA_BATCH_MIN_BATCH_SIZE=10
INFRA_NEBULA_BATCH_MEMORY_THRESHOLD=80
INFRA_NEBULA_BATCH_PROCESSING_TIMEOUT=300000
INFRA_NEBULA_BATCH_RETRY_ATTEMPTS=3
INFRA_NEBULA_BATCH_RETRY_DELAY=100
INFRA_NEBULA_BATCH_ADAPTIVE_BATCHING_ENABLED=true
INFRA_NEBULA_BATCH_PERFORMANCE_THRESHOLD=1000
INFRA_NEBULA_BATCH_ADJUSTMENT_FACTOR=0.1
INFRA_NEBULA_CONNECTION_MAX_CONNECTIONS=10
INFRA_NEBULA_CONNECTION_MIN_CONNECTIONS=2
INFRA_NEBULA_CONNECTION_CONNECTION_TIMEOUT=30000
INFRA_NEBULA_CONNECTION_IDLE_TIMEOUT=300000
INFRA_NEBULA_CONNECTION_ACQUIRE_TIMEOUT=1000
INFRA_NEBULA_CONNECTION_VALIDATION_INTERVAL=60000
INFRA_NEBULA_CONNECTION_ENABLE_CONNECTION_POOLING=true
INFRA_NEBULA_GRAPH_DEFAULT_SPACE=default
INFRA_NEBULA_GRAPH_SPACE_PARTITION_NUM=10
INFRA_NEBULA_GRAPH_SPACE_REPLICA_FACTOR=1
INFRA_NEBULA_GRAPH_SPACE_VID_TYPE=FIXED_STRING
INFRA_NEBULA_GRAPH_QUERY_TIMEOUT=3000
INFRA_NEBULA_GRAPH_QUERY_RETRY_ATTEMPTS=3
INFRA_NEBULA_GRAPH_SCHEMA_AUTO_CREATE_TAGS=false
INFRA_NEBULA_GRAPH_SCHEMA_AUTO_CREATE_EDGES=false

# 事务配置
INFRA_TRANSACTION_TIMEOUT=30000
INFRA_TRANSACTION_RETRY_ATTEMPTS=3
INFRA_TRANSACTION_RETRY_DELAY=1000
INFRA_TRANSACTION_ENABLE_TWO_PHASE_COMMIT=true
INFRA_TRANSACTION_MAX_CONCURRENT_TRANSACTIONS=100
INFRA_TRANSACTION_DEADLOCK_DETECTION_TIMEOUT=500
```

## 配置项详细说明

基础设施配置涵盖了应用程序运行所需的各种底层服务配置，包括：

- **通用配置**: 控制基础设施服务的通用行为
- **Qdrant特定配置**: 优化Qdrant向量数据库的性能和连接管理
- **Nebula特定配置**: 优化Nebula图数据库的性能和连接管理
- **事务配置**: 管理分布式事务的行为和超时设置