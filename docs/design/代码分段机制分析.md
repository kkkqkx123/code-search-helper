# ä»£ç åˆ†æ®µæœºåˆ¶åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ†æå½“å‰ä»£ç æœç´¢åŠ©æ‰‹é¡¹ç›®åœ¨åµŒå…¥å‰å¤„ç†é˜¶æ®µçš„ä»£ç åˆ†æ®µæœºåˆ¶ï¼Œè¯„ä¼°tree-sitterå’ŒLSPæŠ€æœ¯çš„å¼•å…¥ä»·å€¼ï¼Œå¹¶æå‡ºæ”¹è¿›å»ºè®®ã€‚

## ğŸ” å½“å‰åˆ†æ®µæœºåˆ¶åˆ†æ

### 1. ä¸»è¦åˆ†æ®µå®ç°

å½“å‰é¡¹ç›®é‡‡ç”¨ä¸¤ç§ä¸»è¦çš„åˆ†æ®µç­–ç•¥ï¼š

#### a) ç®€å•è¡Œåˆ†å‰²ç­–ç•¥ (IndexSyncService)
- **ä½ç½®**: `src/service/index/IndexSyncService.ts` ä¸­çš„ `chunkFile` æ–¹æ³•
- **ç­–ç•¥**: æŒ‰å›ºå®šè¡Œæ•°åˆ†å‰² (100è¡Œ/å—ï¼Œ10è¡Œé‡å )
- **ä¼˜ç‚¹**: å®ç°ç®€å•ï¼Œæ€§èƒ½é«˜æ•ˆ
- **ç¼ºç‚¹**: è¯­ä¹‰ä¸å®Œæ•´ï¼Œå¯èƒ½åˆ‡æ–­ä»£ç ç»“æ„

```typescript
private chunkFile(content: string, filePath: string): FileChunk[] {
    const lines = content.split('\n');
    const chunks: FileChunk[] = [];
    
    const chunkSize = 100; // æ¯ä¸ªå—çš„è¡Œæ•°
    const chunkOverlap = 10; // å—ä¹‹é—´çš„é‡å è¡Œæ•°
    
    for (let i = 0; i < lines.length; i += chunkSize - chunkOverlap) {
        // ... ç®€å•è¡Œåˆ†å‰²é€»è¾‘
    }
    return chunks;
}
```

#### b) ASTæ„ŸçŸ¥åˆ†æ®µç­–ç•¥ (refç›®å½•)
- **ä½ç½®**: `ref/src/service/parser/splitting/ASTCodeSplitter.ts`
- **ç­–ç•¥**: åŸºäºè¯­æ³•æ ‘çš„ç»“æ„åŒ–åˆ†å‰²
- **ç‰¹ç‚¹**: ä¼˜å…ˆæŒ‰å‡½æ•°å’Œç±»åˆ†å—ï¼Œå›é€€åˆ°é€šç”¨åˆ†å—
- **çŠ¶æ€**: ç›®å‰ä»…åœ¨refç›®å½•ä¸­ï¼Œæœªé›†æˆåˆ°ä¸»é¡¹ç›®

### 2. Tree-sitteré›†æˆç°çŠ¶

#### å½“å‰å®ç°
- **ä½ç½®**: `ref/src/service/parser/core/parse/TreeSitterCoreService.ts`
- **çŠ¶æ€**: æ¨¡æ‹Ÿå®ç°ï¼ŒéçœŸå®Tree-sitteré›†æˆ
- **æ”¯æŒè¯­è¨€**: TypeScriptã€JavaScriptã€Pythonã€Javaã€Goã€Rustã€C++ã€Cã€C#ã€Scalaç­‰
- **åŠŸèƒ½**: å‡½æ•°æå–ã€ç±»æå–ã€å¯¼å…¥å¯¼å‡ºåˆ†æ

#### å½“å‰é™åˆ¶
```typescript
// å½“å‰ä¸ºæ¨¡æ‹Ÿå®ç°ï¼ŒéçœŸå®Tree-sitter
private createBasicParser = () => {
    return {
        parse: (code: string) => {
            const mockAST = this.createMockAST(code); // æ¨¡æ‹ŸAST
            return { rootNode: mockAST };
        }
    };
};
```

### 3. LSPé›†æˆç°çŠ¶

#### é…ç½®çŠ¶æ€
- **LSPé…ç½®**: åœ¨é…ç½®ç³»ç»Ÿä¸­å·²å®šä¹‰ (`LSPConfig` æ¥å£)
- **é»˜è®¤å¯ç”¨**: `enabled: true` (ä½†å®é™…æœªå®Œå…¨é›†æˆ)
- **æ”¯æŒè¯­è¨€**: TypeScriptã€JavaScriptã€Pythonã€Javaã€Goã€Rustã€C++ã€Cã€C#ã€PHPã€Ruby

#### å®ç°çŠ¶æ€
- **æœç´¢æœåŠ¡**: `ref/src/service/lsp/LSPSearchService.ts` å·²å®ç°
- **å¢å¼ºæœç´¢**: `ref/src/service/search/LSPEnhancedSearchService.ts` å·²å®ç°
- **å®¢æˆ·ç«¯**: `ref/src/service/lsp/LSPClient.ts` åŸºç¡€æ¡†æ¶
- **çŠ¶æ€**: ä»£ç å­˜åœ¨ä½†æœªå®Œå…¨é›†æˆåˆ°ä¸»æµç¨‹

## ğŸ¯ Tree-sitteræŠ€æœ¯ä¼˜åŠ¿åˆ†æ

### 1. è¯­æ³•æ„ŸçŸ¥åˆ†æ®µä¼˜åŠ¿
- **ç»“æ„å®Œæ•´æ€§**: ä¿æŒå‡½æ•°ã€ç±»ã€æ–¹æ³•çš„å®Œæ•´æ€§
- **è¯­ä¹‰ç›¸å…³æ€§**: ç›¸å…³ä»£ç å—ä¿æŒåœ¨ä¸€èµ·
- **è¾¹ç•Œç²¾ç¡®**: ç²¾ç¡®çš„èµ·å§‹å’Œç»“æŸä½ç½®

### 2. å¤šè¯­è¨€æ”¯æŒ
Tree-sitteræ”¯æŒ50+ç§ç¼–ç¨‹è¯­è¨€ï¼ŒåŒ…æ‹¬:
- **ä¸»æµè¯­è¨€**: JavaScript/TypeScriptã€Pythonã€Javaã€Goã€Rust
- **å‰ç«¯æŠ€æœ¯**: JSXã€TSXã€Vueã€Svelte
- **ç³»ç»Ÿè¯­è¨€**: Cã€C++ã€Rust
- **è„šæœ¬è¯­è¨€**: Rubyã€PHPã€Lua

### 3. æ€§èƒ½è€ƒè™‘
- **é«˜æ•ˆè§£æ**: Tree-sitterè§£æé€Ÿåº¦å¿«ï¼Œå†…å­˜å ç”¨ä½
- **å¢é‡è§£æ**: æ”¯æŒå¢é‡æ›´æ–°ï¼Œé€‚åˆå¤§å‹ä»£ç åº“
- **é”™è¯¯æ¢å¤**: å¼ºå¤§çš„é”™è¯¯æ¢å¤æœºåˆ¶

## ğŸš€ LSPæŠ€æœ¯ä¼˜åŠ¿åˆ†æ

### 1. è¯­ä¹‰ç†è§£èƒ½åŠ›
- **ç¬¦å·è§£æ**: ç²¾ç¡®çš„å‡½æ•°ã€å˜é‡ã€ç±»è¯†åˆ«
- **ç±»å‹ä¿¡æ¯**: ä¸°å¯Œçš„ç±»å‹ç³»ç»Ÿå’Œç±»å‹æ¨æ–­
- **å¼•ç”¨åˆ†æ**: è·¨æ–‡ä»¶çš„å¼•ç”¨å’Œå®šä¹‰å…³ç³»

### 2. å¼€å‘å·¥å…·é›†æˆ
- **ç¼–è¾‘å™¨å…¼å®¹**: ä¸VSCodeã€IntelliJç­‰IDEå…±äº«è¯­è¨€æœåŠ¡å™¨
- **æ ‡å‡†åŒ–åè®®**: è¯­è¨€æœåŠ¡å™¨åè®®(LSP)æ˜¯è¡Œä¸šæ ‡å‡†
- **ç”Ÿæ€ä¸°å¯Œ**: ä¸°å¯Œçš„è¯­è¨€æœåŠ¡å™¨ç”Ÿæ€ç³»ç»Ÿ

### 3. æ™ºèƒ½åŠŸèƒ½
- **ä»£ç è¡¥å…¨**: åŸºäºä¸Šä¸‹æ–‡çš„æ™ºèƒ½è¡¥å…¨
- **é‡æ„æ”¯æŒ**: é‡å‘½åã€æå–ç­‰é‡æ„æ“ä½œ
- **é”™è¯¯æ£€æµ‹**: å®æ—¶è¯­æ³•å’Œè¯­ä¹‰é”™è¯¯æ£€æµ‹

## ğŸ“Š æŠ€æœ¯å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | å½“å‰ç®€å•åˆ†æ®µ | Tree-sitteråˆ†æ®µ | LSPå¢å¼ºåˆ†æ®µ |
|------|-------------|----------------|-------------|
| è¯­ä¹‰å®Œæ•´æ€§ | âŒ ä½ | âœ… é«˜ | âœ… éå¸¸é«˜ |
| å¤šè¯­è¨€æ”¯æŒ | âœ… é€šç”¨ | âœ… 50+è¯­è¨€ | âœ… è¯­è¨€æœåŠ¡å™¨ä¾èµ– |
| æ€§èƒ½å¼€é”€ | âœ… å¾ˆä½ | âœ… ä¸­ç­‰ | âŒ è¾ƒé«˜ |
| å®ç°å¤æ‚åº¦ | âœ… ç®€å• | âœ… ä¸­ç­‰ | âŒ å¤æ‚ |
| å‡†ç¡®æ€§ | âŒ ä½ | âœ… é«˜ | âœ… éå¸¸é«˜ |
| å®æ—¶æ€§ | âœ… å³æ—¶ | âœ… å³æ—¶ | âŒ éœ€è¦è¯­è¨€æœåŠ¡å™¨ |

## ğŸ’¡ æ¨èå®æ–½æ–¹æ¡ˆ

### é˜¶æ®µä¸€: é›†æˆTree-sitteråˆ†æ®µ (çŸ­æœŸ)

#### 1. è¿ç§»ASTCodeSplitter
```typescript
// ä»refç›®å½•è¿ç§»åˆ°srcç›®å½•
src/service/parser/ASTCodeSplitter.ts
```

#### 2. é…ç½®Tree-sitterä¾èµ–
```json
// package.json æ·»åŠ ä¾èµ–
"dependencies": {
    "tree-sitter": "^0.21.0",
    "tree-sitter-typescript": "^0.21.0",
    "tree-sitter-javascript": "^0.21.0",
    "tree-sitter-python": "^0.21.0",
    // ... å…¶ä»–è¯­è¨€æ”¯æŒ
}
```

#### 3. æ›´æ–°IndexSyncService
```typescript
private chunkFile(content: string, filePath: string): FileChunk[] {
    const language = this.detectLanguage(filePath);
    
    // ä¼˜å…ˆä½¿ç”¨ASTæ„ŸçŸ¥åˆ†æ®µ
    try {
        const astChunks = await this.astSplitter.split(content, language, filePath);
        if (astChunks.length > 0) {
            return astChunks;
        }
    } catch (error) {
        // å¤±è´¥æ—¶å›é€€åˆ°ç®€å•åˆ†æ®µ
        this.logger.warn(`AST splitting failed, falling back to simple splitting: ${error}`);
    }
    
    // ç®€å•åˆ†æ®µä½œä¸ºå›é€€
    return this.simpleChunking(content, filePath);
}
```

### é˜¶æ®µäºŒ: LSPé›†æˆ (ä¸­æœŸ)

#### 1. é€‰æ‹©æ€§å¯ç”¨LSP
```typescript
// åœ¨é…ç½®ä¸­æ§åˆ¶LSPå¯ç”¨
interface IndexSyncOptions {
    useLSP?: boolean; // æ–°å¢é€‰é¡¹
    lspTimeout?: number;
}

// åœ¨ç´¢å¼•æ—¶æ ¹æ®é…ç½®å†³å®šæ˜¯å¦ä½¿ç”¨LSP
```

#### 2. LSPå¢å¼ºåˆ†æ®µ
```typescript
private async enhancedChunking(content: string, filePath: string): Promise<FileChunk[]> {
    if (!this.config.lsp.enabled) {
        return this.astChunking(content, filePath);
    }
    
    try {
        const lspResult = await this.lspService.analyzeFile(filePath, content);
        return this.createLSPAwareChunks(content, lspResult);
    } catch (error) {
        this.logger.warn(`LSP analysis failed: ${error}`);
        return this.astChunking(content, filePath);
    }
}
```

### é˜¶æ®µä¸‰: æ··åˆåˆ†æ®µç­–ç•¥ (é•¿æœŸ)

#### 1. æ™ºèƒ½åˆ†æ®µå†³ç­–
```typescript
interface ChunkingStrategy {
    priority: number;
    canHandle(language: string, content: string): boolean;
    chunk(content: string, filePath: string): Promise<FileChunk[]>;
}

// æ³¨å†Œå¤šç§åˆ†æ®µç­–ç•¥
const strategies: ChunkingStrategy[] = [
    new LSPChunkingStrategy(),    // æœ€é«˜ä¼˜å…ˆçº§
    new ASTChunkingStrategy(),     // ä¸­ç­‰ä¼˜å…ˆçº§  
    new SimpleChunkingStrategy()   // æœ€ä½ä¼˜å…ˆçº§
];
```

#### 2. è´¨é‡è¯„ä¼°æœºåˆ¶
```typescript
interface ChunkQualityMetrics {
    structuralIntegrity: number; // ç»“æ„å®Œæ•´æ€§
    semanticCohesion: number;   // è¯­ä¹‰å†…èšæ€§  
    relevanceScore: number;     // æœç´¢ç›¸å…³æ€§
}

// è¯„ä¼°åˆ†æ®µè´¨é‡ï¼Œé€‰æ‹©æœ€ä½³ç­–ç•¥
```

## ğŸ¯ å®æ–½è·¯çº¿å›¾

### é˜¶æ®µä¸€ (1-2å‘¨): Tree-sitteråŸºç¡€é›†æˆ
- [ ] è¿ç§»ASTCodeSplitteråˆ°srcç›®å½•
- [ ] æ·»åŠ Tree-sitterä¾èµ–
- [ ] å®ç°å¤šè¯­è¨€è¯­æ³•æ”¯æŒ
- [ ] æ›´æ–°IndexSyncServiceä½¿ç”¨ASTåˆ†æ®µ

### é˜¶æ®µäºŒ (2-3å‘¨): LSPåˆæ­¥é›†æˆ  
- [ ] é…ç½®LSPå®¢æˆ·ç«¯åŸºç¡€æ¡†æ¶
- [ ] å®ç°é€‰æ‹©æ€§LSPå¯ç”¨
- [ ] æ·»åŠ LSPåˆ†æ®µå›é€€æœºåˆ¶
- [ ] æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

### é˜¶æ®µä¸‰ (3-4å‘¨): æ™ºèƒ½åˆ†æ®µä¼˜åŒ–
- [ ] å®ç°åˆ†æ®µç­–ç•¥ç®¡ç†å™¨
- [ ] æ·»åŠ åˆ†æ®µè´¨é‡è¯„ä¼°
- [ ] ä¼˜åŒ–åˆ†æ®µå‚æ•°è‡ªé€‚åº”
- [ ] å®Œæ•´çš„æµ‹è¯•è¦†ç›–

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### 1. æœç´¢è´¨é‡æå‡
- **ç²¾ç¡®åº¦æå‡**: é¢„è®¡æœç´¢ç›¸å…³åº¦æå‡30-50%
- **å¬å›ç‡æ”¹å–„**: å®Œæ•´ä»£ç ç»“æ„æé«˜æœç´¢ç»“æœè¦†ç›–ç‡
- **ç”¨æˆ·ä½“éªŒ**: æ›´å‡†ç¡®çš„ä»£ç ç‰‡æ®µå’Œä¸Šä¸‹æ–‡

### 2. å¼€å‘æ•ˆç‡æå‡
- **è°ƒè¯•æ—¶é—´å‡å°‘**: å‡†ç¡®çš„ä»£ç å®šä½å‡å°‘è°ƒè¯•æ—¶é—´
- **ä»£ç ç†è§£**: æ›´å¥½çš„ä»£ç ç»“æ„å’Œå…³ç³»å±•ç¤º
- **ç»´æŠ¤æˆæœ¬**: æ›´æ¸…æ™°çš„ä»£ç ç»„ç»‡é™ä½ç»´æŠ¤æˆæœ¬

### 3. ç³»ç»Ÿå¯æ‰©å±•æ€§
- **å¤šè¯­è¨€æ”¯æŒ**: è½»æ¾æ‰©å±•æ–°çš„ç¼–ç¨‹è¯­è¨€
- **æ¶æ„çµæ´»æ€§**: æ¨¡å—åŒ–è®¾è®¡æ”¯æŒæœªæ¥æ‰©å±•
- **æ€§èƒ½ä¼˜åŒ–**: åˆ†æ®µç­–ç•¥å¯æ ¹æ®åœºæ™¯ä¼˜åŒ–

## âš ï¸ é£é™©ä¸æŒ‘æˆ˜

### 1. æ€§èƒ½è€ƒè™‘
- **LSPå¼€é”€**: è¯­è¨€æœåŠ¡å™¨å¯èƒ½å¼•å…¥æ€§èƒ½å¼€é”€
- **å†…å­˜ä½¿ç”¨**: Tree-sitterè§£æéœ€è¦é¢å¤–å†…å­˜
- **å¯åŠ¨æ—¶é—´**: è¯­è¨€æœåŠ¡å™¨å¯åŠ¨å¯èƒ½è¾ƒæ…¢

### 2. ä¾èµ–ç®¡ç†
- **è¯­è¨€æœåŠ¡å™¨**: éœ€è¦ç®¡ç†å¤šç§è¯­è¨€æœåŠ¡å™¨çš„å®‰è£…å’Œé…ç½®
- **ç‰ˆæœ¬å…¼å®¹**: ä¸åŒè¯­è¨€æœåŠ¡å™¨çš„ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜
- **ç³»ç»Ÿè¦æ±‚**: å¯èƒ½å¢åŠ ç³»ç»Ÿä¾èµ–è¦æ±‚

### 3. æ•…éšœå¤„ç†
- **æœåŠ¡ç¨³å®šæ€§**: è¯­è¨€æœåŠ¡å™¨å¯èƒ½å´©æºƒæˆ–ä¸ç¨³å®š
- **å›é€€æœºåˆ¶**: éœ€è¦å¥å£®çš„å›é€€ç­–ç•¥
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

## âœ… ç»“è®ºä¸å»ºè®®

### å¼ºçƒˆæ¨èå¼•å…¥Tree-sitter
**ç«‹å³è¡ŒåŠ¨**: é›†æˆTree-sitterè¿›è¡Œè¯­æ³•æ„ŸçŸ¥åˆ†æ®µï¼Œè¿™æ˜¯æˆæœ¬æ•ˆç›Šæœ€é«˜çš„æ”¹è¿›ã€‚

### è°¨æ…å¼•å…¥LSP  
**åˆ†é˜¶æ®µå®æ–½**: å…ˆåœ¨å°èŒƒå›´æµ‹è¯•LSPé›†æˆï¼Œè¯„ä¼°å®é™…æ•ˆæœåå†å†³å®šå…¨é¢æ¨å¹¿ã€‚

### å®æ–½ä¼˜å…ˆçº§
1. **é«˜ä¼˜å…ˆçº§**: Tree-sitteré›†æˆ (1-2å‘¨)
2. **ä¸­ä¼˜å…ˆçº§**: LSPåŸºç¡€æ¡†æ¶ (2-3å‘¨)  
3. **ä½ä¼˜å…ˆçº§**: æ™ºèƒ½åˆ†æ®µä¼˜åŒ– (3-4å‘¨)

é€šè¿‡åˆ†é˜¶æ®µå®æ–½ï¼Œå¯ä»¥ä»¥è¾ƒä½çš„é£é™©è·å¾—æ˜¾è‘—çš„åˆ†æ®µè´¨é‡æå‡ï¼ŒåŒæ—¶ä¸ºæœªæ¥çš„æ™ºèƒ½ä»£ç åˆ†æå¥ å®šåŸºç¡€ã€‚