# 日志功能文档

## 概述

本项目实现了一个基于TypeScript的日志系统，提供文件日志记录和控制台输出功能。日志系统支持多种日志级别，并能根据应用退出类型自动管理日志文件的生命周期。

## 核心功能

### 1. 日志级别
- **INFO**: 一般信息日志
- **WARN**: 警告日志
- **ERROR**: 错误日志
- **DEBUG**: 调试日志

### 2. 日志文件管理
- **自动创建**: 应用启动时自动在`logs`目录下创建日志文件
- **命名规则**: `{服务名}-{时间戳}.log`
- **正常退出**: 应用正常退出时自动删除日志文件
- **异常退出**: 应用异常退出时保留日志文件用于问题排查

### 3. 输出方式
- **文件输出**: 日志同时写入文件和控制台
- **控制台输出**: 所有日志都会在控制台显示
- **格式统一**: `[时间戳] [日志级别] 日志内容`

## 文件结构

### 核心文件

#### `src/utils/logger.ts`
日志系统的核心实现文件，包含Logger类。

**主要组件：**
- `Logger`类：主要的日志记录器
- `initialize()`方法：异步初始化日志目录和文件流
- `ensureLogDirectory()`方法：确保日志目录存在
- `ensureLogStream()`方法：确保日志文件流可用
- `writeLog()`方法：核心日志写入逻辑
- `cleanup()`方法：清理资源，根据退出类型决定是否删除日志
- `markAsNormalExit()`方法：标记为正常退出并执行清理

#### `src/main.ts`
应用程序入口文件，集成日志系统。

**主要功能：**
- 创建Logger实例
- 在应用启动和停止时记录日志
- 处理进程信号，确保正常退出时正确清理日志

### 日志目录

#### `logs/`
日志文件存储目录，包含：
- 应用运行时生成的日志文件
- 测试时生成的日志文件

## 使用方法

### 1. 基本使用

```typescript
import { Logger } from './utils/logger.js';

// 创建日志实例
const logger = new Logger('my-service');

// 记录不同级别的日志
await logger.info('应用启动');
await logger.warn('配置警告');
await logger.error('发生错误');
await logger.debug('调试信息');
```

### 2. 在应用中使用

```typescript
class Application {
  private logger: Logger;

  constructor() {
    this.logger = new Logger('my-app');
  }

  async start(): Promise<void> {
    await this.logger.info('应用启动中...');
    // 应用启动逻辑
    await this.logger.info('应用启动完成');
  }

  async stop(): Promise<void> {
    await this.logger.info('应用停止中...');
    // 应用停止逻辑
    await this.logger.info('应用停止完成');
    // 标记为正常退出，删除日志文件
    await this.logger.markAsNormalExit();
  }
}
```

## 配置说明

### 日志文件位置
- 默认位置：`{项目根目录}/logs/`
- 可通过修改`process.cwd()`来改变日志目录

### 日志文件命名
- 格式：`{服务名}-{时间戳}.log`
- 时间戳格式：`YYYY-MM-DDTHH-MM-SS-SSSZ`
- 示例：`codebase-index-mcp-2025-09-27T07-01-49-035Z.log`

### 日志格式
- 文件格式：`[时间戳] [日志级别] 日志内容`
- 控制台格式：`[日志级别] 日志内容`

## 生命周期管理

### 1. 应用启动
1. 创建Logger实例
2. 自动创建logs目录
3. 创建日志文件并打开文件流
4. 设置进程退出处理器

### 2. 应用运行
1. 所有日志同时写入文件和控制台
2. 文件流保持打开状态以提高性能

### 3. 应用退出
- **正常退出**（Ctrl+C、process.exit(0)）：
  1. 关闭文件流
  2. 删除日志文件
  3. 进程退出

- **异常退出**（未捕获异常、未处理的Promise拒绝）：
  1. 记录错误信息
  2. 关闭文件流
  3. 保留日志文件
  4. 进程退出

## 错误处理

### 1. 文件操作错误
- 日志目录创建失败：在控制台输出错误，不影响应用运行
- 日志文件打开失败：在控制台输出错误，只输出到控制台
- 日志写入失败：关闭文件流，后续日志只输出到控制台

### 2. 异步操作处理
- 所有异步操作都有错误捕获
- 初始化失败不会阻止应用启动
- 日志写入失败不会影响应用功能

## 测试

### 测试文件
- `test-logger.ts`: 日志功能测试脚本（临时文件）

### 测试方法
```bash
npx tsx test-logger.ts
```

### 测试内容
- 日志文件创建
- 多种日志级别写入
- 日志内容格式验证
- 文件读取和内容验证

## 注意事项

1. **时区**: 当前使用UTC时间，后续将统一使用+8时区
2. **性能**: 日志写入是异步的，不会阻塞主线程
3. **并发**: 多个Logger实例可以同时使用，互不影响
4. **磁盘空间**: 正常退出时自动清理日志，不会占用磁盘空间
5. **调试**: 异常退出时保留日志，便于问题排查

## 未来改进

1. **时区支持**: 统一使用+8时区
2. **日志轮转**: 支持按文件大小或时间轮转
3. **日志级别过滤**: 支持运行时动态调整日志级别
4. **远程日志**: 支持将日志发送到远程服务器
5. **结构化日志**: 支持JSON格式的结构化日志