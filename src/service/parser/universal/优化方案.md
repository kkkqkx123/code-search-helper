## 优化方案

### 1. 解决语言检测功能冗余

**方案**: 统一语言检测服务，将重复的检测逻辑合并

- 将 `ProcessingStrategySelector` 和 `UnifiedDetectionCenter` 中的检测逻辑统一到 `UnifiedDetectionCenter`
- 保留 `ProcessingStrategySelector` 作为策略选择专用组件，调用统一的检测中心
- 简化 `IntelligentFallbackEngine` 的检测逻辑，复用统一检测结果

### 2. 重构处理策略选择逻辑

**方案**: 创建独立的策略管理器

- 创建 `StrategyManager` 统一管理策略选择逻辑
- 将 `ProcessingStrategyFactory` 仅保留工厂职责，不包含具体策略实现
- 将具体策略实现移至独立文件，按策略类型组织

### 3. 优化 `UniversalTextSplitter` 职责

**方案**: 遵循单一职责原则，拆分功能

- 将 Markdown 和 XML 专门处理逻辑移至对应的专门分段器
- 将保护机制协调职责移至专门的保护协调器
- 将处理器链管理职责移至专门的处理器管理器
- `UniversalTextSplitter` 仅保留核心分段职责

### 4. 重构策略实现与工厂职责

**方案**: 将策略实现与工厂职责分离

- 将 `ProcessingStrategyFactory.ts` 中的具体策略实现（如 `ASTStrategy`, `MarkdownStrategy` 等）移至独立文件
- 工厂类仅负责创建和返回策略实例
- 策略类独立管理自己的实现逻辑

### 5. 统一结构化文件检测

**方案**: 创建统一的文件特征检测服务

- 将 `isStructuredFile` 和 `isHighlyStructured` 逻辑统一到一个特征检测服务中
- 提供统一的 API 供其他组件调用

### 6. 优化目录结构

```
src/service/parser/universal/
├── core/                          # 核心分段逻辑
│   ├── UniversalTextSplitter.ts   # 纯分段职责
│   └── interfaces/                # 核心接口定义
├── detection/                     # 检测逻辑
│   ├── UnifiedDetectionCenter.ts  # 统一检测中心
│   └── LanguageDetector.ts        # 语言检测
├── strategy/                      # 策略实现
│   ├── IProcessingStrategy.ts     # 策略接口
│   ├── ProcessingStrategyFactory.ts # 纯工厂实现
│   ├── ASTStrategy.ts             # AST策略实现
│   ├── MarkdownStrategy.ts        # Markdown策略实现
│   ├── XMLStrategy.ts             # XML策略实现
│   ├── SemanticStrategy.ts        # 语义策略实现
│   ├── BracketStrategy.ts         # 括号策略实现
│   └── LineStrategy.ts            # 行策略实现
├── coordination/                  # 协调逻辑
│   ├── ProcessingStrategySelector.ts # 策略选择器
│   ├── StrategyManager.ts         # 策略管理器
│   └── interfaces/                # 协调接口
├── processors/                    # 专门处理器
│   ├── MarkdownTextSplitter.ts    # Markdown处理器
│   └── XMLTextSplitter.ts         # XML处理器
├── protection/                    # 保护机制
│   ├── ProtectionCoordinator.ts   # 保护协调器
│   └── interfaces/                # 保护接口
├── fallback/                      # 降级处理
│   └── IntelligentFallbackEngine.ts # 智能降级引擎
├── types/                         # 类型定义
│   └── SegmentationTypes.ts       # 分段类型定义
├── utils/                         # 工具函数
│   └── FileFeatureDetector.ts     # 文件特征检测
└── constants.ts                   # 常量定义
```

### 7. 优化接口设计

- 简化 `IProcessingStrategy` 接口，只保留必要方法
- 优化 `SegmentationTypes.ts` 中的类型定义，去除冗余接口
- 统一错误处理和日志记录方式