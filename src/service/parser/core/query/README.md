# Query System - æŸ¥è¯¢ç³»ç»Ÿ

æœ¬ç›®å½•åŒ…å« Tree-sitter æŸ¥è¯¢å¼•æ“çš„å®Œæ•´å®ç°ï¼Œè´Ÿè´£ä» ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ä¸­æå–ä»£ç ç»“æ„ä¿¡æ¯ã€‚

## ğŸ“‹ ç›®å½•æ¦‚è§ˆ

### æ ¸å¿ƒå¼•æ“ç±»

#### 1. **TreeSitterQueryFacade.ts** - æŸ¥è¯¢é—¨é¢ç±»
- **èŒè´£**: ä¸ºå¸¸è§ç”¨ä¾‹æä¾›ç®€å•æ˜“ç”¨çš„æ¥å£
- **æ ¸å¿ƒåŠŸèƒ½**:
  - `findFunctions()`, `findClasses()`, `findImports()` ç­‰ä¾¿æ·æŸ¥è¯¢æ–¹æ³•
  - `findMultiple()` - æ‰¹é‡æŸ¥è¯¢å¤šç§ç±»å‹èŠ‚ç‚¹
  - `findAllMainStructures()` - æŸ¥æ‰¾æ‰€æœ‰ä¸»è¦ä»£ç ç»“æ„
  - `warmupCache()` - ç¼“å­˜é¢„çƒ­
  - `executeQueryDetailed()` - æ‰§è¡Œè¯¦ç»†æŸ¥è¯¢
- **ç‰¹ç‚¹**: 
  - å†…ç½®ç¼“å­˜ç®¡ç†å’Œæ€§èƒ½ä¼˜åŒ–
  - æ”¯æŒé”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶
  - å¹¶è¡ŒæŸ¥è¯¢æ‰§è¡Œæå‡æ€§èƒ½

#### 2. **TreeSitterQueryExecutor.ts** - æŸ¥è¯¢æ‰§è¡Œå¼•æ“
- **èŒè´£**: æ ¸å¿ƒæŸ¥è¯¢æ‰§è¡Œå’Œæ¨¡å¼ç®¡ç†
- **æ ¸å¿ƒæ¥å£å’Œç±»**:
  - `QueryPattern` - æŸ¥è¯¢æ¨¡å¼å®šä¹‰ï¼ˆåŒ…å«S-expressionã€æ•è·ç­‰ï¼‰
  - `QueryMatch` - åŒ¹é…ç»“æœï¼ˆèŠ‚ç‚¹ã€æ•è·ã€ä½ç½®ä¿¡æ¯ï¼‰
  - `QueryResult` - æŸ¥è¯¢ç»“æœï¼ˆåŒ¹é…æ•°ç»„ã€æ‰§è¡Œæ—¶é—´ã€æˆåŠŸæ ‡å¿—ï¼‰
  - `TreeSitterQueryEngine` - ä¸»å¼•æ“ç±»
- **ä¸»è¦æ–¹æ³•**:
  - `executeQuery()` - æ‰§è¡Œå•ä¸ªæŸ¥è¯¢
  - `executeMultipleQueries()` - æ‰¹é‡æ‰§è¡ŒæŸ¥è¯¢
  - `executeQueryPattern()` - ä½¿ç”¨åŸç”Ÿ tree-sitter Query API
  - `executeGraphQueries()` - æ‰§è¡Œå›¾ç´¢å¼•æŸ¥è¯¢
- **ç‰¹ç‚¹**:
  - æ”¯æŒé¢„ç¼–è¯‘æŸ¥è¯¢å¯¹è±¡ç¼“å­˜
  - å†…ç½®æ€§èƒ½ç›‘æ§
  - è‡ªåŠ¨å¼‚æ­¥åˆå§‹åŒ–

### åŠ è½½å’Œæ³¨å†Œç±»

#### 3. **QueryLoader.ts** - æŸ¥è¯¢åŠ è½½å™¨
- **èŒè´£**: åŠ¨æ€åŠ è½½å’Œç®¡ç†æŸ¥è¯¢æ–‡ä»¶
- **æ ¸å¿ƒåŠŸèƒ½**:
  - `loadLanguageQueries()` - å¼‚æ­¥åŠ è½½æŒ‡å®šè¯­è¨€çš„æŸ¥è¯¢
  - `getQuery()` - è·å–ç‰¹å®šè¯­è¨€å’Œç±»å‹çš„æŸ¥è¯¢å­—ç¬¦ä¸²
  - `discoverQueryTypes()` - åŠ¨æ€å‘ç°æŸ¥è¯¢ç±»å‹
  - `validateQuerySyntax()` - éªŒè¯æŸ¥è¯¢è¯­æ³•æ­£ç¡®æ€§
  - `preloadCommonLanguages()` - é¢„åŠ è½½å¸¸ç”¨è¯­è¨€
- **ç‰¹ç‚¹**:
  - æ”¯æŒæ–°æ—§ç›®å½•ç»“æ„å…¼å®¹
  - æ™ºèƒ½æŸ¥è¯¢åˆ†ç±»ï¼ˆå°¤å…¶æ˜¯ç®€å•è¯­è¨€ï¼‰
  - è¯¦ç»†çš„é”™è¯¯æŠ¥å‘Šå’Œæ—¥å¿—è®°å½•
  - æ‰¹é‡åŠ è½½ä¼˜åŒ–

#### 4. **QueryRegistry.ts** - æŸ¥è¯¢æ³¨å†Œè¡¨
- **èŒè´£**: ç®¡ç†æ‰€æœ‰è¯­è¨€çš„æŸ¥è¯¢æ¨¡å¼
- **æ ¸å¿ƒç±»**: `QueryRegistryImpl`
- **ä¸»è¦åŠŸèƒ½**:
  - `getPattern()` - è·å–æŸ¥è¯¢æ¨¡å¼ï¼ˆå¼‚æ­¥ï¼‰
  - `getPatternSync()` - åŒæ­¥è·å–ï¼ˆå‘åå…¼å®¹ï¼‰
  - `getPatternsForLanguage()` - è·å–æŒ‡å®šè¯­è¨€çš„æ‰€æœ‰æ¨¡å¼
  - `getSupportedLanguages()` - è·å–æ”¯æŒçš„è¯­è¨€åˆ—è¡¨
  - `reloadLanguageQueries()` - é‡æ–°åŠ è½½è¯­è¨€æŸ¥è¯¢
- **æ”¯æŒçš„è¯­è¨€**: javascript, typescript, python, java, go, rust, cpp, c, csharp, swift, kotlin, ruby, php, scala, embedded-template

#### 5. **QueryManager.ts** - æŸ¥è¯¢ç®¡ç†å™¨
- **èŒè´£**: é«˜çº§æŸ¥è¯¢ç®¡ç†å’ŒæŸ¥è¯¢æ‰§è¡Œæ§åˆ¶
- **æ ¸å¿ƒåŠŸèƒ½**:
  - `getQuery()` - è·å– Parser.Query å¯¹è±¡
  - `getQueryString()` - è·å–æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆå¼‚æ­¥ï¼‰
  - `executeQuery()` - æ‰§è¡ŒæŸ¥è¯¢
  - `executeBatchQueries()` - æ‰¹é‡æ‰§è¡ŒæŸ¥è¯¢
  - `combinePatterns()` - åˆå¹¶å¤šä¸ªæŸ¥è¯¢æ¨¡å¼
- **ç‰¹ç‚¹**:
  - å…³ç³»æŸ¥è¯¢çš„æ¡ä»¶æ‰§è¡Œï¼ˆåŸºäº NEBULA_ENABLEDï¼‰
  - LRU ç¼“å­˜ç®¡ç†ï¼ˆ100 ä¸ªæŸ¥è¯¢ï¼Œ50 ä¸ªæ¨¡å¼ï¼‰
  - æ”¯æŒæŸ¥è¯¢å’Œæ¨¡å¼ç¼“å­˜

### ç¼“å­˜å’Œæ€§èƒ½ç±»

#### 6. **QueryCache.ts** - ç»Ÿä¸€ç¼“å­˜ç®¡ç†
- **èŒè´£**: ç®¡ç†æ‰€æœ‰æŸ¥è¯¢ç›¸å…³çš„ç¼“å­˜
- **ç®¡ç†ä¸‰å±‚ç¼“å­˜**:
  - `queryCache` - é¢„ç¼–è¯‘æŸ¥è¯¢å¯¹è±¡ç¼“å­˜ï¼ˆå®¹é‡ï¼š200ï¼‰
  - `resultCache` - æŸ¥è¯¢ç»“æœç¼“å­˜ï¼ˆå®¹é‡ï¼š500ï¼‰
  - `astCache` - AST å¯¹è±¡ç¼“å­˜ï¼ˆå®¹é‡ï¼š200ï¼‰
- **æ ¸å¿ƒæ–¹æ³•**:
  - `getQuery()` - è·å–æˆ–åˆ›å»ºç¼“å­˜çš„æŸ¥è¯¢å¯¹è±¡
  - `getResult()` / `setResult()` - ç®¡ç†ç»“æœç¼“å­˜
  - `getAst()` / `setAst()` - ç®¡ç† AST ç¼“å­˜
  - `getAllStats()` - è·å–æ‰€æœ‰ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
- **ç‰¹ç‚¹**: æ”¯æŒè¯¦ç»†çš„ç¼“å­˜ç»Ÿè®¡ï¼ŒåŒ…æ‹¬å‘½ä¸­ç‡ã€å¤§å°ç­‰

#### 7. **CacheKeyGenerator.ts** - ç¼“å­˜é”®ç”Ÿæˆå™¨
- **èŒè´£**: ä¸ºä¸åŒæŸ¥è¯¢å¼•æ“æä¾›ä¸€è‡´çš„ç¼“å­˜é”®ç”Ÿæˆç­–ç•¥
- **ç”Ÿæˆçš„é”®ç±»å‹**:
  - `SIMPLE_QUERY_PREFIX` - ç®€å•æŸ¥è¯¢é”®
  - `TREE_SITTER_QUERY_PREFIX` - Tree-sitter æŸ¥è¯¢é”®
  - `BATCH_QUERY_PREFIX` - æ‰¹é‡æŸ¥è¯¢é”®
  - `AST_PREFIX` - AST ç¼“å­˜é”®
- **æ ¸å¿ƒæ–¹æ³•**:
  - `forSimpleQuery()` - ä¸ºç®€å•æŸ¥è¯¢ç”Ÿæˆé”®
  - `forTreeSitterQuery()` - ä¸º Tree-sitter æŸ¥è¯¢ç”Ÿæˆé”®
  - `forBatchQuery()` - ä¸ºæ‰¹é‡æŸ¥è¯¢ç”Ÿæˆé”®
  - `forAst()` - ä¸º AST ç”Ÿæˆé”®
  - `generateContentHash()` - åŸºäº AST å†…å®¹ç”Ÿæˆå“ˆå¸Œ
- **ç‰¹ç‚¹**: ä½¿ç”¨ FNV-1a å“ˆå¸Œç®—æ³•ç¡®ä¿å”¯ä¸€æ€§

#### 8. **QueryPerformanceMonitor.ts** - æ€§èƒ½ç›‘æ§å™¨
- **èŒè´£**: ç›‘æ§å’Œç»Ÿè®¡æŸ¥è¯¢æ‰§è¡Œæ€§èƒ½
- **æ ¸å¿ƒåŠŸèƒ½**:
  - `recordQuery()` - è®°å½•æŸ¥è¯¢æ‰§è¡Œæ—¶é—´
  - `recordCacheHit()` - è®°å½•ç¼“å­˜å‘½ä¸­
  - `getMetrics()` - è·å–æŸ¥è¯¢ç±»å‹çš„è¯¦ç»†æŒ‡æ ‡
  - `getSystemMetrics()` - è·å–ç³»ç»Ÿçº§æŒ‡æ ‡
  - `getSummary()` - è·å–æ€§èƒ½æ€»ç»“
  - `startPeriodicMonitoring()` - å¯åŠ¨å‘¨æœŸæ€§ç›‘æ§
- **ç‰¹ç‚¹**: æ”¯æŒæŒ‰æŸ¥è¯¢ç±»å‹çš„è¯¦ç»†ç»Ÿè®¡

### é…ç½®å’Œå·¥å…·ç±»

#### 9. **query-config.ts** - æŸ¥è¯¢é…ç½®ç³»ç»Ÿ
- **èŒè´£**: åŠ¨æ€ç®¡ç†æŸ¥è¯¢ç±»å‹é…ç½®å’ŒéªŒè¯
- **æ ¸å¿ƒæ¥å£**:
  - `QueryTypeConfig` - æŸ¥è¯¢ç±»å‹é…ç½®
  - `CompoundQueryConfig` - å¤åˆæŸ¥è¯¢é…ç½®
  - `ConfigValidationResult` - éªŒè¯ç»“æœ
- **ä¸»è¦ç±»**: `QueryConfigManager` (å•ä¾‹)
- **æ ¸å¿ƒåŠŸèƒ½**:
  - `registerQueryType()` - æ³¨å†ŒæŸ¥è¯¢ç±»å‹
  - `registerCompoundQuery()` - æ³¨å†Œå¤åˆæŸ¥è¯¢
  - `getQueryTypesForLanguage()` - è·å–è¯­è¨€æ”¯æŒçš„æŸ¥è¯¢ç±»å‹
  - `getQueryTypesByCategory()` - æŒ‰åˆ†ç±»è·å–æŸ¥è¯¢ç±»å‹
  - `validateQueryTypeConfig()` - é…ç½®éªŒè¯
- **é¢„å®šä¹‰çš„æŸ¥è¯¢ç±»å‹**:
  - æ ¸å¿ƒç±»å‹ï¼šfunctions, classes, methods, imports, exports, variables, types, interfaces, properties
  - æ‰©å±•ç±»å‹ï¼šcontrolFlow, expression, decorator
- **å¤åˆæŸ¥è¯¢ç¤ºä¾‹**: functions-types, classes-functions, methods-variables ç­‰

#### 10. **QueryEngineFactory.ts** - æŸ¥è¯¢å¼•æ“å·¥å‚
- **èŒè´£**: æä¾› TreeSitterQueryEngine çš„å•ä¾‹å®ä¾‹
- **æ ¸å¿ƒæ–¹æ³•**:
  - `getInstance()` - è·å–å•ä¾‹å®ä¾‹
  - `resetInstance()` - é‡ç½®å®ä¾‹ï¼ˆä¸»è¦ç”¨äºæµ‹è¯•ï¼‰
  - `isInitialized()` - æ£€æŸ¥å®ä¾‹æ˜¯å¦å·²åˆå§‹åŒ–

#### 11. **GlobalQueryInitializer.ts** - å…¨å±€åˆå§‹åŒ–ç®¡ç†å™¨
- **èŒè´£**: ç¡®ä¿æŸ¥è¯¢ç³»ç»Ÿåªåˆå§‹åŒ–ä¸€æ¬¡
- **æ ¸å¿ƒåŠŸèƒ½**:
  - `initialize()` - å…¨å±€å•æ¬¡åˆå§‹åŒ–
  - `reinitialize()` - é‡æ–°åˆå§‹åŒ–
  - `getStatus()` - è·å–åˆå§‹åŒ–çŠ¶æ€
  - `isInitialized()` - æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€
- **ç‰¹ç‚¹**: é˜²æ­¢é‡å¤åˆå§‹åŒ–ï¼Œå¤„ç†å¹¶å‘åˆå§‹åŒ–è¯·æ±‚

#### 12. **QueryPatternExtractor.ts** - æ¨¡å¼æå–å™¨
- **èŒè´£**: ä»å®Œæ•´æŸ¥è¯¢ä¸­æå–ç‰¹å®šæ¨¡å¼
- **æ ¸å¿ƒæ–¹æ³•**:
  - `extractPatterns()` - æå–ç‰¹å®šå…³é”®è¯çš„æ¨¡å¼
  - `extractAllPatterns()` - æ ¹æ®æ˜ å°„æå–æ‰€æœ‰æ¨¡å¼
- **ç‰¹ç‚¹**: æ”¯æŒæ‹¬å·å¹³è¡¡æ£€æŸ¥ï¼Œè·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ

#### 13. **QueryTransformer.ts** - æŸ¥è¯¢è½¬æ¢å™¨ âš ï¸
- **çŠ¶æ€**: å·²åºŸå¼ƒï¼Œç­‰å¾…ç§»é™¤
- **åŸèŒè´£**: å°†å®Œæ•´æŸ¥è¯¢è½¬æ¢ä¸ºç‰¹å®šç±»å‹çš„ç®€åŒ–æ¨¡å¼
- **æ³¨**: ç°å·²ç”± QueryPatternExtractor æ›¿ä»£

#### 14. **QueryRegistryCompatibility.ts** - å‘åå…¼å®¹æ€§åŒ…è£…å™¨ âš ï¸
- **èŒè´£**: ç¡®ä¿ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­å·¥ä½œ
- **åŠŸèƒ½**: åŒ…è£… QueryRegistryImpl æä¾›å…¼å®¹æ¥å£
- **è¯´æ˜**: ç­‰å¾…é‡æ„å®Œæˆåå¯ç§»é™¤

#### 15. **GlobalQueryInitializer.md** - åˆå§‹åŒ–è¯´æ˜æ–‡æ¡£
- åŒ…å«å…¨å±€åˆå§‹åŒ–çš„è¯¦ç»†è®¾è®¡è¯´æ˜

## ğŸ—ï¸ æ¶æ„å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         TreeSitterQueryFacade (é—¨é¢)                â”‚
â”‚     æä¾›ç®€å•çš„é«˜å±‚æŸ¥è¯¢æ¥å£                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚
         â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  QueryManager    â”‚  â”‚  QueryEngineFactory â”‚
â”‚  (æŸ¥è¯¢ç®¡ç†)      â”‚  â”‚   (å•ä¾‹å·¥å‚)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   TreeSitterQueryEngine (æ‰§è¡Œå¼•æ“)        â”‚
â”‚   æ ¸å¿ƒæŸ¥è¯¢æ‰§è¡Œé€»è¾‘                       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚
     â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QueryLoader  â”‚  â”‚ QueryRegistry     â”‚
â”‚ (åŠ è½½å™¨)     â”‚  â”‚ (æ³¨å†Œè¡¨)          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚
       â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Query Files (æŸ¥è¯¢å®šä¹‰æ–‡ä»¶)     â”‚
â”‚  src/service/parser/constants/queriesâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¼“å­˜å±‚ (æ‰€æœ‰å¼•æ“å…±äº«):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  QueryCache  â”‚ CacheKeyGenerator â”‚ Performanceâ”‚
â”‚  (ä¸‰å±‚ç¼“å­˜)  â”‚    (é”®ç”Ÿæˆ)      â”‚  Monitor   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é…ç½®å±‚:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  QueryConfigManager (é…ç½®) â”‚
â”‚  - æŸ¥è¯¢ç±»å‹å®šä¹‰            â”‚
â”‚  - å¤åˆæŸ¥è¯¢                â”‚
â”‚  - éªŒè¯                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆå§‹åŒ–:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GlobalQueryInitializer     â”‚
â”‚ (å…¨å±€å•æ¬¡åˆå§‹åŒ–)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹
```
GlobalQueryInitializer.initialize()
    â”œâ”€â–º QueryRegistryImpl.initialize()
    â”‚   â”œâ”€â–º QueryLoader.loadLanguageQueries(language)
    â”‚   â”‚   â”œâ”€â–º å°è¯•åŠ è½½æ–°ç»“æ„ (index.ts)
    â”‚   â”‚   â”œâ”€â–º å›é€€åˆ°æ—§ç»“æ„
    â”‚   â”‚   â””â”€â–º æ™ºèƒ½åˆ†ç±» (QueryPatternExtractor)
    â”‚   â””â”€â–º å­˜å‚¨åˆ° patterns Map
    â””â”€â–º è¿”å›åˆå§‹åŒ–çŠ¶æ€
```

### 2. æŸ¥è¯¢æ‰§è¡Œæµç¨‹
```
TreeSitterQueryFacade.findXxx(ast, language)
    â”œâ”€â–º optimizedQuery(ast, queryType, language)
    â”‚   â”œâ”€â–º ç”Ÿæˆç¼“å­˜é”® (CacheKeyGenerator)
    â”‚   â”œâ”€â–º æ£€æŸ¥ç¼“å­˜ (QueryCache)
    â”‚   â”œâ”€â–º å¦‚æœæœªç¼“å­˜ï¼š
    â”‚   â”‚   â””â”€â–º queryEngine.executeQuery()
    â”‚   â”‚       â”œâ”€â–º æ£€æŸ¥å¼•æ“ç¼“å­˜
    â”‚   â”‚       â”œâ”€â–º executeQueryPattern()
    â”‚   â”‚       â”‚   â”œâ”€â–º è·å–è¯­è¨€å¯¹è±¡
    â”‚   â”‚       â”‚   â”œâ”€â–º åˆ›å»º/è·å–ç¼“å­˜çš„ Query å¯¹è±¡
    â”‚   â”‚       â”‚   â””â”€â–º query.matches(ast)
    â”‚   â”‚       â”œâ”€â–º è®°å½•æ€§èƒ½æŒ‡æ ‡
    â”‚   â”‚       â””â”€â–º ç¼“å­˜ç»“æœ
    â”‚   â””â”€â–º è¿”å›ç»“æœ
    â””â”€â–º è¿”å›èŠ‚ç‚¹æ•°ç»„
```

### 3. æ‰¹é‡æŸ¥è¯¢æµç¨‹
```
TreeSitterQueryFacade.findMultiple(ast, language, types[])
    â”œâ”€â–º ä½¿ç”¨å¹¶è¡Œ Promise.all()
    â”œâ”€â–º å¯¹æ¯ä¸ªæŸ¥è¯¢ç±»å‹ï¼š
    â”‚   â”œâ”€â–º æ£€æŸ¥å•ä¸ªæŸ¥è¯¢ç¼“å­˜
    â”‚   â”œâ”€â–º å¦‚æœæœªç¼“å­˜ï¼Œæ‰§è¡ŒæŸ¥è¯¢
    â”‚   â””â”€â–º ç¼“å­˜å•ä¸ªç»“æœ
    â”œâ”€â–º å¡«å……ç»“æœ Map
    â”œâ”€â–º ç¼“å­˜æ‰¹é‡ç»“æœ
    â””â”€â–º è¿”å› Map<queryType, nodes[]>
```

## ğŸ“Š ç¼“å­˜ç­–ç•¥

### ä¸‰å±‚ç¼“å­˜æ¶æ„
```
ç¬¬ä¸€å±‚: QueryCache.queryCache (Parser.Query å¯¹è±¡)
  â”œâ”€ å®¹é‡: 200 æ¡ç›®
  â”œâ”€ é”®æ ¼å¼: "{language}:{hash(pattern)}"
  â””â”€ ç”¨é€”: ç¼“å­˜é¢„ç¼–è¯‘çš„æŸ¥è¯¢å¯¹è±¡

ç¬¬äºŒå±‚: QueryCache.resultCache (æŸ¥è¯¢ç»“æœ)
  â”œâ”€ å®¹é‡: 500 æ¡ç›®
  â”œâ”€ é”®æ ¼å¼: "prefix:hash:queryType:language"
  â””â”€ ç”¨é€”: ç¼“å­˜æŸ¥è¯¢æ‰§è¡Œç»“æœ

ç¬¬ä¸‰å±‚: QueryCache.astCache (AST å¯¹è±¡)
  â”œâ”€ å®¹é‡: 200 æ¡ç›®
  â”œâ”€ é”®æ ¼å¼: "ast:{hash}"
  â””â”€ ç”¨é€”: ç¼“å­˜è§£æåçš„ AST
```

### ç¼“å­˜é”®ç”Ÿæˆç­–ç•¥
```
ç®€å•æŸ¥è¯¢:   "simple:{contentHash}:{queryType}:{language}"
æ ‘æŸ¥è¯¢:     "treesitter:{contentHash}:{patternName}:{language}"
æ‰¹é‡æŸ¥è¯¢:   "batch:{contentHash}:batch:{typesHash}:{language}"
AST:        "ast:{normalizedKey}"
```

## ğŸ”§ é…ç½®ç¤ºä¾‹

### ç¯å¢ƒå˜é‡
```bash
# å¯ç”¨/ç¦ç”¨å…³ç³»æŸ¥è¯¢ï¼ˆNebula å›¾æ•°æ®åº“ï¼‰
NEBULA_ENABLED=true|false
```

### ä»£ç é…ç½®ç¤ºä¾‹

#### æ‰§è¡Œç®€å•æŸ¥è¯¢
```typescript
import { TreeSitterQueryFacade } from './TreeSitterQueryFacade';

// æŸ¥æ‰¾å‡½æ•°
const functions = await TreeSitterQueryFacade.findFunctions(ast, 'typescript');

// æŸ¥æ‰¾å¤šç§ç±»å‹
const results = await TreeSitterQueryFacade.findMultiple(
  ast, 
  'typescript', 
  ['functions', 'classes', 'imports']
);
```

#### æ‰§è¡Œè¯¦ç»†æŸ¥è¯¢
```typescript
// è·å–å®Œæ•´çš„ QueryResult å¯¹è±¡
const result = await TreeSitterQueryFacade.executeQueryDetailed(
  ast, 
  'functions', 
  'typescript'
);

console.log(result.matches);        // åŒ¹é…é¡¹
console.log(result.executionTime);  // æ‰§è¡Œæ—¶é—´
console.log(result.success);        // æ˜¯å¦æˆåŠŸ
```

#### ç¼“å­˜é¢„çƒ­
```typescript
// é¢„åŠ è½½å¸¸è§æŸ¥è¯¢
await TreeSitterQueryFacade.warmupCache(ast, 'typescript');

// è·å–æ€§èƒ½ç»Ÿè®¡
const stats = TreeSitterQueryFacade.getPerformanceStats();
console.log(stats.cacheStats);
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å…³é”®ä¼˜åŒ–ç­–ç•¥

1. **å¤šå±‚ç¼“å­˜**
   - Parser.Query å¯¹è±¡ç¼“å­˜ï¼ˆé¿å…é‡å¤åˆ›å»ºï¼‰
   - æŸ¥è¯¢ç»“æœç¼“å­˜ï¼ˆé¿å…é‡å¤æ‰§è¡Œï¼‰
   - AST å¯¹è±¡ç¼“å­˜

2. **æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–**
   - ä½¿ç”¨ `Promise.all()` å¹¶è¡Œæ‰§è¡ŒæŸ¥è¯¢
   - å•ä¸ªæŸ¥è¯¢ç»“æœç¼“å­˜åœ¨æ‰¹é‡æŸ¥è¯¢ä¸­é‡ç”¨

3. **å†…å­˜ç®¡ç†**
   - LRU ç¼“å­˜è‡ªåŠ¨æ·˜æ±°è¿‡æœŸæ¡ç›®
   - é¢„åˆ†é…æ•°ç»„é¿å…åŠ¨æ€æ‰©å±•
   - å¯¹è±¡æ± å¤ç”¨

4. **å¼‚æ­¥åˆå§‹åŒ–**
   - å»¶è¿ŸåŠ è½½æŸ¥è¯¢å®šä¹‰
   - å¹¶å‘é™åˆ¶é¿å…èµ„æºäº‰ç”¨
   - ç­‰å¾…è¶…æ—¶æœºåˆ¶

### ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§
```typescript
const stats = TreeSitterQueryFacade.getPerformanceStats();
console.log(stats.queryMetrics);    // æŒ‰æŸ¥è¯¢ç±»å‹ç»Ÿè®¡
console.log(stats.querySummary);    // æ±‡æ€»ç»Ÿè®¡
console.log(stats.cacheStats);      // ç¼“å­˜å‘½ä¸­ç‡
```

## ğŸ› é”™è¯¯å¤„ç†

### å¼‚å¸¸å¤„ç†ç­–ç•¥

1. **QueryLoader å¼‚å¸¸**
   - å°è¯•æ–°ç›®å½•ç»“æ„
   - å›é€€åˆ°æ—§ç›®å½•ç»“æ„
   - è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

2. **QueryExecutor å¼‚å¸¸**
   - è¿”å›ç©ºåŒ¹é…æ•°ç»„
   - è®°å½•é”™è¯¯ä¿¡æ¯
   - ç»§ç»­æ‰§è¡Œï¼ˆä¸ä¸­æ–­ï¼‰

3. **ç¼“å­˜å¼‚å¸¸**
   - å¼‚å¸¸ä¸ä¸­æ–­æŸ¥è¯¢æ‰§è¡Œ
   - è¿”å›æ— ç¼“å­˜çš„æŸ¥è¯¢ç»“æœ
   - æ—¥å¿—è®°å½•å¼‚å¸¸

## ğŸ§ª æµ‹è¯•

æµ‹è¯•æ–‡ä»¶ä½ç½®: `src/service/parser/core/query/__tests__/`

### æµ‹è¯•è¦†ç›–
- QueryLoader åŠ è½½é€»è¾‘
- QueryRegistry æ³¨å†Œè¡¨æ“ä½œ
- ç¼“å­˜ç®¡ç†å’Œå‘½ä¸­ç‡
- æ€§èƒ½ç›‘æ§å‡†ç¡®æ€§
- åˆå§‹åŒ–æµç¨‹

## ğŸ“ æ·»åŠ æ–°çš„æŸ¥è¯¢ç±»å‹

### æ­¥éª¤ 1: å®šä¹‰æŸ¥è¯¢é…ç½®
```typescript
// åœ¨ query-config.ts ä¸­æ·»åŠ 
const newQueryConfig: QueryTypeConfig = {
  name: 'myqueries',
  description: 'æˆ‘çš„è‡ªå®šä¹‰æŸ¥è¯¢',
  nodeTypes: ['node_type_1', 'node_type_2'],
  priority: 20,
  isCore: false,
  supportedLanguages: ['typescript', 'javascript'],
  category: 'custom',
  dependencies: [],
  tags: ['custom', 'myfeature']
};

queryConfigManager.registerQueryType(newQueryConfig);
```

### æ­¥éª¤ 2: åˆ›å»ºæŸ¥è¯¢å®šä¹‰æ–‡ä»¶
```
src/service/parser/constants/queries/{language}/myqueries.ts
```

### æ­¥éª¤ 3: å¯¼å‡ºæŸ¥è¯¢æ¨¡å¼
```typescript
// myqueries.ts
export default `
  ; æŸ¥è¯¢å®šä¹‰
  (node_type_1 @myqueries1)
  (node_type_2 @myqueries2)
`;
```

### æ­¥éª¤ 4: ä½¿ç”¨æŸ¥è¯¢
```typescript
const results = await TreeSitterQueryFacade.findMultiple(
  ast,
  'typescript',
  ['myqueries']
);
```

## ğŸ”— ä¾èµ–å…³ç³»

- **tree-sitter**: åŸºç¡€ AST è§£æå’ŒæŸ¥è¯¢åº“
- **LoggerService**: æ—¥å¿—è®°å½•
- **LRUCache**: ç¼“å­˜å®ç°
- **PerformanceMonitor**: æ€§èƒ½ç›‘æ§
- **languageMappingManager**: è¯­è¨€æ˜ å°„ç®¡ç†

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [GlobalQueryInitializer.md](./GlobalQueryInitializer.md) - åˆå§‹åŒ–ç³»ç»Ÿè®¾è®¡
- [æ ‘æŸ¥è¯¢è¯­è¨€](https://tree-sitter.github.io/tree-sitter/queries) - Tree-sitter å®˜æ–¹æ–‡æ¡£

## ğŸš€ ä½¿ç”¨å»ºè®®

1. **åˆå§‹åŒ–**
   ```typescript
   // åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–
   await GlobalQueryInitializer.initialize();
   ```

2. **æŸ¥è¯¢**
   ```typescript
   // ä½¿ç”¨ Facade è·å¾—æœ€ä½³æ€§èƒ½
   const functions = await TreeSitterQueryFacade.findFunctions(ast, language);
   ```

3. **ç›‘æ§**
   ```typescript
   // å®šæœŸæ£€æŸ¥æ€§èƒ½æŒ‡æ ‡
   const stats = TreeSitterQueryFacade.getPerformanceStats();
   ```

4. **æ¸…ç†**
   ```typescript
   // åº”ç”¨å…³é—­æ—¶æ¸…é™¤ç¼“å­˜
   TreeSitterQueryFacade.clearCache();
   ```

---

**æœ€åæ›´æ–°**: 2025-11-27
